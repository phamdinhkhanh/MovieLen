
% Default to the notebook output style

    


% Inherit from the specified cell style.




    
\documentclass[11pt]{article}

    
    
    \usepackage[T1]{fontenc}
    % Nicer default font (+ math font) than Computer Modern for most use cases
    \usepackage{mathpazo}

    % Basic figure setup, for now with no caption control since it's done
    % automatically by Pandoc (which extracts ![](path) syntax from Markdown).
    \usepackage{graphicx}
    % We will generate all images so they have a width \maxwidth. This means
    % that they will get their normal width if they fit onto the page, but
    % are scaled down if they would overflow the margins.
    \makeatletter
    \def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth
    \else\Gin@nat@width\fi}
    \makeatother
    \let\Oldincludegraphics\includegraphics
    % Set max figure width to be 80% of text width, for now hardcoded.
    \renewcommand{\includegraphics}[1]{\Oldincludegraphics[width=.8\maxwidth]{#1}}
    % Ensure that by default, figures have no caption (until we provide a
    % proper Figure object with a Caption API and a way to capture that
    % in the conversion process - todo).
    \usepackage{caption}
    \DeclareCaptionLabelFormat{nolabel}{}
    \captionsetup{labelformat=nolabel}

    \usepackage{adjustbox} % Used to constrain images to a maximum size 
    \usepackage{xcolor} % Allow colors to be defined
    \usepackage{enumerate} % Needed for markdown enumerations to work
    \usepackage{geometry} % Used to adjust the document margins
    \usepackage{amsmath} % Equations
    \usepackage{amssymb} % Equations
    \usepackage{textcomp} % defines textquotesingle
    % Hack from http://tex.stackexchange.com/a/47451/13684:
    \AtBeginDocument{%
        \def\PYZsq{\textquotesingle}% Upright quotes in Pygmentized code
    }
    \usepackage{upquote} % Upright quotes for verbatim code
    \usepackage{eurosym} % defines \euro
    \usepackage[mathletters]{ucs} % Extended unicode (utf-8) support
    \usepackage[utf8x]{inputenc} % Allow utf-8 characters in the tex document
    \usepackage{fancyvrb} % verbatim replacement that allows latex
    \usepackage{grffile} % extends the file name processing of package graphics 
                         % to support a larger range 
    % The hyperref package gives us a pdf with properly built
    % internal navigation ('pdf bookmarks' for the table of contents,
    % internal cross-reference links, web links for URLs, etc.)
    \usepackage{hyperref}
    \usepackage{longtable} % longtable support required by pandoc >1.10
    \usepackage{booktabs}  % table support for pandoc > 1.12.2
    \usepackage[inline]{enumitem} % IRkernel/repr support (it uses the enumerate* environment)
    \usepackage[normalem]{ulem} % ulem is needed to support strikethroughs (\sout)
                                % normalem makes italics be italics, not underlines
    

    
    
    % Colors for the hyperref package
    \definecolor{urlcolor}{rgb}{0,.145,.698}
    \definecolor{linkcolor}{rgb}{.71,0.21,0.01}
    \definecolor{citecolor}{rgb}{.12,.54,.11}

    % ANSI colors
    \definecolor{ansi-black}{HTML}{3E424D}
    \definecolor{ansi-black-intense}{HTML}{282C36}
    \definecolor{ansi-red}{HTML}{E75C58}
    \definecolor{ansi-red-intense}{HTML}{B22B31}
    \definecolor{ansi-green}{HTML}{00A250}
    \definecolor{ansi-green-intense}{HTML}{007427}
    \definecolor{ansi-yellow}{HTML}{DDB62B}
    \definecolor{ansi-yellow-intense}{HTML}{B27D12}
    \definecolor{ansi-blue}{HTML}{208FFB}
    \definecolor{ansi-blue-intense}{HTML}{0065CA}
    \definecolor{ansi-magenta}{HTML}{D160C4}
    \definecolor{ansi-magenta-intense}{HTML}{A03196}
    \definecolor{ansi-cyan}{HTML}{60C6C8}
    \definecolor{ansi-cyan-intense}{HTML}{258F8F}
    \definecolor{ansi-white}{HTML}{C5C1B4}
    \definecolor{ansi-white-intense}{HTML}{A1A6B2}

    % commands and environments needed by pandoc snippets
    % extracted from the output of `pandoc -s`
    \providecommand{\tightlist}{%
      \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
    \DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
    % Add ',fontsize=\small' for more characters per line
    \newenvironment{Shaded}{}{}
    \newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{\textbf{{#1}}}}
    \newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.56,0.13,0.00}{{#1}}}
    \newcommand{\DecValTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{{#1}}}
    \newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{{#1}}}
    \newcommand{\FloatTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{{#1}}}
    \newcommand{\CharTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
    \newcommand{\StringTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
    \newcommand{\CommentTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textit{{#1}}}}
    \newcommand{\OtherTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{{#1}}}
    \newcommand{\AlertTok}[1]{\textcolor[rgb]{1.00,0.00,0.00}{\textbf{{#1}}}}
    \newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.02,0.16,0.49}{{#1}}}
    \newcommand{\RegionMarkerTok}[1]{{#1}}
    \newcommand{\ErrorTok}[1]{\textcolor[rgb]{1.00,0.00,0.00}{\textbf{{#1}}}}
    \newcommand{\NormalTok}[1]{{#1}}
    
    % Additional commands for more recent versions of Pandoc
    \newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.53,0.00,0.00}{{#1}}}
    \newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
    \newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
    \newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.73,0.40,0.53}{{#1}}}
    \newcommand{\ImportTok}[1]{{#1}}
    \newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.73,0.13,0.13}{\textit{{#1}}}}
    \newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
    \newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
    \newcommand{\VariableTok}[1]{\textcolor[rgb]{0.10,0.09,0.49}{{#1}}}
    \newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{\textbf{{#1}}}}
    \newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.40,0.40,0.40}{{#1}}}
    \newcommand{\BuiltInTok}[1]{{#1}}
    \newcommand{\ExtensionTok}[1]{{#1}}
    \newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.74,0.48,0.00}{{#1}}}
    \newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.49,0.56,0.16}{{#1}}}
    \newcommand{\InformationTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
    \newcommand{\WarningTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
    
    
    % Define a nice break command that doesn't care if a line doesn't already
    % exist.
    \def\br{\hspace*{\fill} \\* }
    % Math Jax compatability definitions
    \def\gt{>}
    \def\lt{<}
    % Document parameters
    \title{MatrixFactorization}
    
    
    

    % Pygments definitions
    
\makeatletter
\def\PY@reset{\let\PY@it=\relax \let\PY@bf=\relax%
    \let\PY@ul=\relax \let\PY@tc=\relax%
    \let\PY@bc=\relax \let\PY@ff=\relax}
\def\PY@tok#1{\csname PY@tok@#1\endcsname}
\def\PY@toks#1+{\ifx\relax#1\empty\else%
    \PY@tok{#1}\expandafter\PY@toks\fi}
\def\PY@do#1{\PY@bc{\PY@tc{\PY@ul{%
    \PY@it{\PY@bf{\PY@ff{#1}}}}}}}
\def\PY#1#2{\PY@reset\PY@toks#1+\relax+\PY@do{#2}}

\expandafter\def\csname PY@tok@w\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.73,0.73}{##1}}}
\expandafter\def\csname PY@tok@c\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@cp\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.74,0.48,0.00}{##1}}}
\expandafter\def\csname PY@tok@k\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@kp\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@kt\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.69,0.00,0.25}{##1}}}
\expandafter\def\csname PY@tok@o\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@ow\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.67,0.13,1.00}{##1}}}
\expandafter\def\csname PY@tok@nb\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@nf\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\expandafter\def\csname PY@tok@nc\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\expandafter\def\csname PY@tok@nn\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\expandafter\def\csname PY@tok@ne\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.82,0.25,0.23}{##1}}}
\expandafter\def\csname PY@tok@nv\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@no\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.53,0.00,0.00}{##1}}}
\expandafter\def\csname PY@tok@nl\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.63,0.63,0.00}{##1}}}
\expandafter\def\csname PY@tok@ni\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.60,0.60,0.60}{##1}}}
\expandafter\def\csname PY@tok@na\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.49,0.56,0.16}{##1}}}
\expandafter\def\csname PY@tok@nt\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@nd\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.67,0.13,1.00}{##1}}}
\expandafter\def\csname PY@tok@s\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@sd\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@si\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.73,0.40,0.53}{##1}}}
\expandafter\def\csname PY@tok@se\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.73,0.40,0.13}{##1}}}
\expandafter\def\csname PY@tok@sr\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.40,0.53}{##1}}}
\expandafter\def\csname PY@tok@ss\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@sx\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@m\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@gh\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,0.50}{##1}}}
\expandafter\def\csname PY@tok@gu\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.50,0.00,0.50}{##1}}}
\expandafter\def\csname PY@tok@gd\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.63,0.00,0.00}{##1}}}
\expandafter\def\csname PY@tok@gi\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.63,0.00}{##1}}}
\expandafter\def\csname PY@tok@gr\endcsname{\def\PY@tc##1{\textcolor[rgb]{1.00,0.00,0.00}{##1}}}
\expandafter\def\csname PY@tok@ge\endcsname{\let\PY@it=\textit}
\expandafter\def\csname PY@tok@gs\endcsname{\let\PY@bf=\textbf}
\expandafter\def\csname PY@tok@gp\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,0.50}{##1}}}
\expandafter\def\csname PY@tok@go\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.53,0.53,0.53}{##1}}}
\expandafter\def\csname PY@tok@gt\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.27,0.87}{##1}}}
\expandafter\def\csname PY@tok@err\endcsname{\def\PY@bc##1{\setlength{\fboxsep}{0pt}\fcolorbox[rgb]{1.00,0.00,0.00}{1,1,1}{\strut ##1}}}
\expandafter\def\csname PY@tok@kc\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@kd\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@kn\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@kr\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@bp\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@fm\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\expandafter\def\csname PY@tok@vc\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@vg\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@vi\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@vm\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@sa\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@sb\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@sc\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@dl\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@s2\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@sh\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@s1\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@mb\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@mf\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@mh\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@mi\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@il\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@mo\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@ch\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@cm\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@cpf\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@c1\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@cs\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}

\def\PYZbs{\char`\\}
\def\PYZus{\char`\_}
\def\PYZob{\char`\{}
\def\PYZcb{\char`\}}
\def\PYZca{\char`\^}
\def\PYZam{\char`\&}
\def\PYZlt{\char`\<}
\def\PYZgt{\char`\>}
\def\PYZsh{\char`\#}
\def\PYZpc{\char`\%}
\def\PYZdl{\char`\$}
\def\PYZhy{\char`\-}
\def\PYZsq{\char`\'}
\def\PYZdq{\char`\"}
\def\PYZti{\char`\~}
% for compatibility with earlier versions
\def\PYZat{@}
\def\PYZlb{[}
\def\PYZrb{]}
\makeatother


    % Exact colors from NB
    \definecolor{incolor}{rgb}{0.0, 0.0, 0.5}
    \definecolor{outcolor}{rgb}{0.545, 0.0, 0.0}



    
    % Prevent overflowing lines due to hard-to-break entities
    \sloppy 
    % Setup hyperref package
    \hypersetup{
      breaklinks=true,  % so long urls are correctly broken across lines
      colorlinks=true,
      urlcolor=urlcolor,
      linkcolor=linkcolor,
      citecolor=citecolor,
      }
    % Slightly bigger margins than the latex defaults
    
    \geometry{verbose,tmargin=1in,bmargin=1in,lmargin=1in,rmargin=1in}
    
    

    \begin{document}
    
    
    \maketitle
    
    

    
    \subsection{1. Giới thiệu về phương pháp Recommendation
system}\label{giux1edbi-thiux1ec7u-vux1ec1-phux1b0ux1a1ng-phuxe1p-recommendation-system}

\subsubsection{1. 1. Tầm quan trọng của recommendation
system}\label{tux1ea7m-quan-trux1ecdng-cux1ee7a-recommendation-system}

Trong cuộc sống hàng ngày chúng ta thường thấy những tình huống khá tình
cờ khi các hệ thống lớn có khả năng đọc và hiểu sở thích của người dùng
và hiện thị những thông tin mà người dùng quan tâm rất chuẩn xác. Chẳng
hạn như:

\begin{itemize}
\tightlist
\item
  Facebook có khả năng hiển thị trên newfeed những trạng thái của những
  người mà bạn quan tâm.
\item
  Youtube có thể tự động nhảy sang những video mà bạn có khả năng yêu
  thích dựa trên những gì mà bạn đang xem.
\item
  Amazon có thể đưa ra những cuốn sách cùng loại với những cuốn sách mà
  bạn đã mua hoặc rating cao.
\item
  Google có thể đưa quảng cáo về một đồ vật phù hợp với những gì bạn tìm
  kiếm gần đây.
\end{itemize}

Nếu không có các thuật toán recommendation, trải nghiệm người dùng sẽ
kém hơn vì thông tin mà họ thực sự quan tâm không được đưa ra đúng thời
điểm trong khi thông tin không cần thiết được đưa ra nhiều hơn. Hậu quả
là người dùng cảm thấy bị làm phiền và nhiễu loạn thông tin. Trong lĩnh
vực marketing hệ thống recommendation lại càng trở nên quan trọng. Mỗi
sản phẩm được đưa đến đúng người tiêu dùng có nhu cầu sẽ làm tăng doanh
thu, giảm chi phí thời gian, chi phí quảng cáo và giúp người tiêu dùng
sở hữu được thứ mình cần. Trong lĩnh vực giải trí như video, game,
truyện online,... người dùng sẽ đạt độ hài lòng cao khi tìm được đúng
loại hình giải trí yêu thích dễ dàng. Dù chỉ ra đời trong 10 năm trở lại
đây, song hành cùng thời kì bùng nổ internet nhưng có thể nói
\texttt{recommendation\ system} là một lĩnh vực nghiên cứu sôi động. Nó
đã tạo ra một cuộc cách mạng thay đổi hành vi mua sắm, hành vi giải trí,
chiến lược kinh doanh,... trên toàn cầu. Hàng trăm triệu các hộ kinh
doanh nhỏ lẻ đang hưởng lợi từ nó thông qua khai thác nguồn khách hàng
vô tận từ tài nguyên mạng và biến kênh bán hàng này thay thế các kênh
truyền thống. Lĩnh vực này đồng thời là chìa khóa mấu chốt giúp các công
ty công nghệ Google, Facebook, Amazon, Microsoft,... trở thành những tập
đoành hàng đầu thể giới. Chính vì thế \texttt{recommendation\ system}
luôn được các công ty kinh doanh trên nền tảng online đầu tư nghiên cứu
và phát triển để tạo ra một hệ thống thông minh nhằm nâng cao trải
nghiệm khách hàng và tối ưu hóa nguồn tài nguyên.

\subsubsection{1.2. Phương pháp
recommendation}\label{phux1b0ux1a1ng-phuxe1p-recommendation}

Bên trên chúng ta đã biết vai trò của \texttt{recommendation\ system}
đối với việc phát triển của lĩnh vực internet và kinh doanh online. Tuy
nhiên thực sự bài toán \texttt{recommendation\ system} là gì? Cơ sở của
phương pháp \texttt{recommendation\ system} ra sao chúng ta vẫn chưa
thực sự hiểu rõ. Theo định nghĩa từ wikipedia thì
\texttt{recommendation\ system} là một nhánh nhỏ của lĩnh vực \emph{hệ
thống chiết lọc thông tin} (information filtering system) được sử dụng
để dự báo mức độ yêu thích thông qua rating của một người dùng (user)
cho một sản phẩm (item). Để đưa ra được sản phẩm phù hợp nhất đến người
dùng đòi hỏi các hệ thống phải dựa trên thông tin đã rating của sản
phẩm, thông tin người dùng, thông tin về sản phẩm để xây dựng thuật toán
tối ưu. Dựa trên hàm loss function để tính ra sai số dự báo của thuật
toán và tìm ra một phương pháp có mức độ dự báo chuẩn xác nhất. Có rất
nhiều các thuật toán khác nhau được sử dụng trong
\texttt{recommendation\ system} nhưng về cơ bản chúng bao gồm 2 phương
pháp chính: \texttt{Collaborative\ filtering} và
\texttt{Content\ based\ filtering}. Điểm khác biệt cơ bản giữa 2 phương
pháp này là:

\begin{itemize}
\item
  Collaborative filtering: Dựa trên mối quan hệ tương quan về mặt hành
  vi tiêu dùng hoặc đặc trưng sản phẩm để tìm ra các users hoặc items có
  chung đặc tính, sở thích. Từ đó dựa trên những thông tin mà nhóm người
  dùng hoặc sản phẩm liên quan gần nhất đã rating để đánh giá sản phẩm
  mà một người dùng cụ thể chưa rating. Tuy nhiên nhược điểm của thuật
  toán này là đưa ra dự báo về rating mà không hoàn toàn hiểu về user,
  item mà hoàn toàn dựa trên quan sát về mức độ tương đương giữa các
  nhóm users, items để dự báo. Thuật toán được sử dụng trong các bài
  toán này chủ yếu là k-nearest neighbor để tìm ra nhóm tương đương và
  ma trận hệ số tương quan được sử dụng để đo lường mức độ gần gũi về
  mặt hành vi hay đặc tính để phân nhóm.
\item
  Content based filtering: Dựa trên những thông tin và nội dung liên
  quan đến sản phẩm như nhà sản xuất, thể loại, năm sản xuất, công dụng,
  đặc tính,... hoặc dựa trên thông tin của người dùng như giới tính, độ
  tuối, ngành nghề,... để đưa ra dự báo về rating của người đối với sản
  phẩm đó. Thuật toán này chỉ đơn thuần là các phương trình hồi qui giữa
  các chiều đặc tính của sản phẩm hoặc người dùng đối với điểm rating mà
  không tận dụng được tương quan về mặt hành vi giữa những nhóm người
  dùng hay đặc trưng sản phẩm như \texttt{Collaborative\ filtering}.
  Trong thực tế hành vi của người dùng lại cho thấy rất giống nhau nếu
  thuộc cùng một nhóm chẳng hạn như các nhóm nhạc thiền, nhạc vàng, nhạc
  trẻ, nhạc thiếu nhi sẽ phù hợp với người già, người trung niên, người
  trẻ, thiếu nhi. Không xem xét được các yếu tố tương quan theo nhóm là
  một hạn chế lớn của content based filtering.
\end{itemize}

Mỗi thuật toán đều có ưu, nhược điểm khác nhau và mức độ hiệu quả trong
dự báo mức độ yêu thích các cặp (user, item) (\emph{người dùng, sản
phẩm}) cũng khác nhau tùy thuộc vào tập dữ liệu. Nhưng các thuật toán
đều có điểm chung đó là sử dụng dữ liệu mà người dùng đã rating đối với
các sản phẩm để làm cơ sở dự báo rating cho các sản phẩm chưa được đánh
giá. Việc này cũng giống như chúng ta chơi trò chơi điền số vào \emph{ma
trận tiện ích} (utility matrix). Một chiều của ma trận ứng với users và
chiều còn lại ứng với items. Các ô trên ma trận thể hiện giá trị rating
của user tương ứng lên item. Như vậy sẽ có những ô đã được rating bởi
người dùng và các ô còn lại chưa được rating. Quá trình giải bài toán
cũng giống như việc chúng ta đi giải ma trận tại những ô còn thiếu sao
cho sai số cuối cùng giữa dự báo và thực tế là nhỏ nhất.

\subsubsection{1.3. Giới thiệu thuật toán matrix
factorization}\label{giux1edbi-thiux1ec7u-thuux1eadt-touxe1n-matrix-factorization}

Trong thuật toán matrix factorization chúng ta giả định đặc trưng của
item được thể hiện qua ma trận \(\mathbf{I}\) và hành vi của người dùng
được thể hiện qua ma trận \(\mathbf{U}\). Với mỗi dòng của ma trận
\(\mathbf{I}\) là một đặc trưng ẩn (\emph{latent feature}) của sản phẩm
và mỗi cột của \(\mathbf{U}\) là mức độ yêu thích của một người dùng đối
với đặc trưng ẩn tương ứng. Các đặc trưng ẩn này có thể coi như những
nhân tố chính được tổng hợp từ nhiều thông tin liên quan đến sản phẩm
tương tự như thành phần chính trong phép phân tích thành phần chính
\texttt{PCA}. Đặc trưng của sản phẩm thứ m được thể hiện qua vector dòng
\(\mathbf{i_m}\) và hành vi của người dùng thứ n được thể hiện qua
vector cột \(\mathbf{u_n}\). Khi đó giá trị dự báo mức độ yêu thích của
một người dùng n lên một sản phẩm m sẽ là tích của 2 vector
\(\mathbf{i_m}\) và \(\mathbf{u_n}\):
\[y_mn = \mathbf{i_m} \mathbf{u_n}\]

ước lượng của ma trận tiện ích \(\mathbf{\hat{Y}}\) sẽ được biểu diễn
theo các ma trận hành vi \(\mathbf{I}\) và ma trận người dùng
\(\mathbf{U}\) như sau:

\[\mathbf{\hat{Y}} \approx \left[ \begin{matrix}
\mathbf{i}_1\mathbf{u}_1 & \mathbf{i}_1\mathbf{u}_2 & \dots & \mathbf{i}_1 \mathbf{u}_N\\
\mathbf{i}_2\mathbf{u}_1 & \mathbf{i}_2\mathbf{u}_2 & \dots & \mathbf{i}_2 \mathbf{u}_N\\
\dots & \dots & \ddots & \dots \\
\mathbf{i}_M\mathbf{u}_1 & \mathbf{i}_M\mathbf{u}_2 & \dots & \mathbf{i}_M \mathbf{u}_N\\
\end{matrix} \right]
 = \left[ \begin{matrix}
\mathbf{i}_1 \\
\mathbf{i}_2 \\
\dots \\
\mathbf{i}_M \\
\end{matrix} \right]
\left[ \begin{matrix}
\mathbf{u}_1 & \mathbf{u}_2 & \dots & \mathbf{u}_N
\end{matrix} \right] = \mathbf{IU}\]

\subsubsection{1.4. Thuật toán gradient
descent}\label{thuux1eadt-touxe1n-gradient-descent}

Giả sử rằng chúng ta đã có thông tin về các ma trận \(\mathbf{U}\) và
\(\mathbf{I}\) điều chúng ta cần thực hiện bây giờ là coi các dòng của
mỗi \(\mathbf{I}\) là một item profile và mỗi cột của \(\mathbf{U}\) là
một user profile. Giả sử \(\mathbf{I} \in \mathbb{R}^{M \times K}\),
\(\mathbf{U} \in \mathbb{R}^{K \times N}\),
\(\mathbf{Y} \in \mathbb{R}^{M \times N}\). Thông thường ta sẽ chọn số
đặc trưng ẩn nhỏ hơn số lượng sản phẩm và người dùng. Khi đó Y sẽ được
biểu diễn dưới dạng tích của 2 ma trận có rank nhỏ hơn (\emph{Low-rank
Matrix factorization}):

\[\hat{\mathbf{Y}} = \mathbf{I}\mathbf{U}\]

Hàm loss function của thuật toán chính là chuẩn
\href{http://mathworld.wolfram.com/FrobeniusNorm.html}{Frobenius norm}
về độ lệch giữa \(\mathbf{Y}\) và \(\mathbf{\hat{Y}}\) như sau:

\[\mathcal{L(\mathbf{I},\mathbf{U})} = \frac{1}{2s}||\mathbf{Y}-\mathbf{\hat{Y}}||_{F}^2\]

Để tránh hiện tượng overfiting
\href{https://towardsdatascience.com/l1-and-l2-regularization-methods-ce25e7fc831c}{hệ
số hiệu chỉnh bậc 2} (\emph{l2 - reguralization}) được đưa thêm vào:

\[\mathcal{L(\mathbf{I},\mathbf{U})} = \frac{1}{2s}||\mathbf{Y}-\mathbf{\hat{Y}}||_{F}^2 + \frac{\lambda_1}{2}||\mathbf{I}||_{F}^2 + \frac{\lambda_2}{2}||\mathbf{U}||_{F}^2 \tag{1.4.1}\]

Nếu coi \(\mathbf{U}\) cố định và cần tối ưu \(\mathbf{I}\). Bài toán
\texttt{Matrix\ factorization} sẽ tương đương với tối ưu hàm loss
function:

\[\mathcal{L(\mathbf{I})} = \frac{1}{2s}||\mathbf{Y}-\mathbf{\hat{Y}}||_{F}^2 + \frac{\lambda_1}{2}||\mathbf{I}||_{F}^2\]
Nếu coi \(\mathbf{I}\) cố định và cần tối ưu \(\mathbf{U}\). Hàm loss
function sẽ có dạng:

\[\mathcal{L(\mathbf{U})} = \frac{1}{2s}||\mathbf{Y}-\mathbf{\hat{Y}}||_{F}^2 + \frac{\lambda_2}{2}||\mathbf{U}||_{F}^2\]

Ta nhận thấy hàm loss function đều là những hàm lồi. Việc tìm nghiệm tối
ưu có thể dựa trên bài toán tối ưu lồi bậc 2 (\emph{Quadratic
Programming}) hoặc cách đơn giản hơn là thông qua thuật toán
\texttt{gradient\ descent}. Chúng ta sẽ sử dụng thuật toán
\texttt{Stochastic\ gradient\ descent} để cập nhật lần lượt từng điểm dữ
liệu trên toàn bộ dữ liệu, sau đó lặp lại quá trình này. Đối với trường
hợp ma trận sản phẩm (\(\mathbf{I}\)) cố định, ta sẽ cần cập nhật ma
trận người dùng (\(\mathbf{U}\)) theo phương gradient descent. Mỗi một
lượt cập nhật, một người dùng u được lựa chọn. Dựa trên thông tin về
những sản phẩm mà người dùng u đã rating. Vector gradient descent được
tính toán để cập nhật giá trị của vector \(\mathbf{u}\) tương ứng. Quá
trình này tiếp tục cho đến khi toàn bộ các vector users được cập nhật.
Tương tự như vậy đối với trường hợp cố định ma trận người dùng cố định
và cập nhật ma trận sản phẩm.

\textbf{Tối ưu ma trận người dùng:}

Để đơn giản hóa quá trình tính toán, ta có thể biểu diễn hàm loss
function theo tổng loss function của từng user như sau:

\[\mathcal{L(\mathbf{U})} = \frac{1}{2s}\sum_{n = 1}^{N}\sum_{m: r_{mn} = 1} (y_{mn} - i_m . u_n)^2+\frac{\lambda_1}{2} ||\mathbf{U}||_{F}^2\]

Trong đó \(r_{mn}\) là phần tử thuộc ma trận rating
\(R \in \mathbb{R}^{M \times N}\) có giá trị 0 hoặc 1. \(r_{mn} = 1\)
đánh dấu sản phẩm m đã được rating bởi user n và bằng 0 trong trường hợp
chưa được rating. Điều kiện \(r_{mn} = 1\) trong hàm loss function là để
lọc ra những sản phẩm đã được rating bởi user n. Khi đó nếu coi
\(\hat{\mathbf{I}}_n\) là ma trận các sản phẩm đã được rating của user n
và \(\hat{y}_n\) là vector kết quả rating tương ứng thì hàm loss
function đối với user n được viết gọn như sau:

\[\mathcal{L(\mathbf{U}| user = n)} = \frac{1}{2s}\sum_{m: r_{mn} = 1}(y_{mn} - \mathbf{i_m} . \mathbf{u_n})^2 + \frac{\lambda_1}{2}||\mathbf{u_n}||^2 = \frac{1}{2s}||\hat{y}_n-\hat{\mathbf{I}}_n. \mathbf{u_n}||^2 + \frac{\lambda_1}{2}||\mathbf{u_n}||^2\]

Đạo hàm của nó tương ứng:

\[\frac{\partial \mathcal{L(\mathbf{U}| user = n)}}{\partial \mathbf{u_n}} = -\frac{1}{s}\hat{\mathbf{I}}_n^{T}\space (\hat{y}_n-\hat{\mathbf{I}}_n. \mathbf{u_n}) + \lambda_1\mathbf{u_n}\]

Công thức cập nhật nghiệm cho mỗi cột của ma trận người dùng:

\[\mathbf{u'_n} = \mathbf{u_n} - \theta (-\frac{1}{s}\hat{\mathbf{I}}_m^{T}\space (\hat{y}_n-\hat{\mathbf{I}}_n. \mathbf{u_n}) + \lambda_1\mathbf{u_n})\]

\textbf{Tối ưu ma trận sản phẩm:}

Hoàn toàn tương tự ta cũng có đối với ma trận sản phẩm, hàm loss
function đối với item = m:

\[\mathcal{L(\mathbf{I}| item = m)} = \frac{1}{2s}\sum_{n: r_{mn} = 1}(y_{mn} - \mathbf{i_m} . \mathbf{u_n})^2 + \frac{\lambda_1}{2}||\mathbf{i_m}||^2 = \frac{1}{2s}||\hat{y}_m-\mathbf{i_m}.\hat{\mathbf{U}}_m||^2 + \frac{\lambda_1}{2}||\mathbf{i_m}||^2\]

Đạo hàm tương ứng đối với mỗi item sẽ là:

\[\frac{\partial \mathcal{L(\mathbf{I}| item = m)}}{\partial \mathbf{i_m}} = -\frac{1}{s}(\hat{y}_n-\mathbf{i_m}. \hat{\mathbf{U}}_m)\hat{\mathbf{U}}_m^{T} + \lambda_1\mathbf{i_m}\]

Công thức cập nhật nghiệm cho mỗi dòng của ma trận sản phẩm:

\[\mathbf{i'_m} = \mathbf{i_m} - \theta (-\frac{1}{s}(\hat{y}_n-\mathbf{i_m}. \hat{\mathbf{U}}_m)\hat{\mathbf{U}}_m^{T} + \lambda_1\mathbf{i_m})\]

\subsection{2. Xây dựng code thuật
toán}\label{xuxe2y-dux1ef1ng-code-thuux1eadt-touxe1n}

\subsubsection{2.1. Thực hành trên bộ dữ liệu movie length
1M}\label{thux1ef1c-huxe0nh-truxean-bux1ed9-dux1eef-liux1ec7u-movie-length-1m}

Chúng ta sẽ thực hiện phương pháp \texttt{matrix\ factorization} trên bộ
dữ liệu
\href{http://files.grouplens.org/datasets/movielens/ml-1m.zip}{Movie
length 1M} gồm 1 triệu các lượt ratings cho khoảng 4000 bộ phim được thu
thập từ 6000 người dùng. Để tiện phù hợp với thuật toán đã xây dựng, các
xử lý dữ liệu sẽ được thực hiện trên ma trận. Load dữ liệu đầu vào như
sau:

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}1}]:} \PY{k+kn}{import} \PY{n+nn}{pandas} \PY{k}{as} \PY{n+nn}{pd}
        \PY{k+kn}{import} \PY{n+nn}{numpy} \PY{k}{as} \PY{n+nn}{np}
        \PY{n}{columns} \PY{o}{=} \PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{user\PYZus{}id}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{item\PYZus{}id}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{rating}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{timestamp}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}
        \PY{n}{movie\PYZus{}length} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{read\PYZus{}csv}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{ml\PYZhy{}1m/ratings.dat}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{header} \PY{o}{=} \PY{l+m+mi}{0}\PY{p}{,} \PYZbs{}
                                   \PY{n}{names} \PY{o}{=} \PY{n}{columns}\PY{p}{,} \PY{n}{sep} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{::}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{engine} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{python}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
        \PY{n}{movie\PYZus{}length} \PY{o}{=} \PY{n}{movie\PYZus{}length}\PY{o}{.}\PY{n}{sort\PYZus{}values}\PY{p}{(}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{user\PYZus{}id}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{item\PYZus{}id}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{)}
        \PY{n}{movie\PYZus{}length}\PY{o}{.}\PY{n}{head}\PY{p}{(}\PY{p}{)}
\end{Verbatim}

            \begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}1}]:}     user\_id  item\_id  rating  timestamp
        39        1        1       5  978824268
        24        1       48       5  978824351
        38        1      150       5  978301777
        43        1      260       4  978300760
        22        1      527       5  978824195
\end{Verbatim}
        
    Kích thước các dữ liệu và số lượng users, items

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}2}]:} \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Data movie length shape: }\PY{l+s+si}{\PYZpc{}s}\PY{l+s+s1}{\PYZsq{}}\PY{o}{\PYZpc{}}\PY{k}{str}(movie\PYZus{}length.shape))
        \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{No customers: }\PY{l+s+si}{\PYZpc{}s}\PY{l+s+s1}{\PYZsq{}}\PY{o}{\PYZpc{}}\PY{k}{str}(np.unique(movie\PYZus{}length.iloc[:, 0]).shape[0]))
        \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{No movies: }\PY{l+s+si}{\PYZpc{}s}\PY{l+s+s1}{\PYZsq{}}\PY{o}{\PYZpc{}}\PY{k}{str}(np.unique(movie\PYZus{}length.iloc[:, 1]).shape[0]))
\end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\}]
Data movie length shape: (1000208, 4)
No customers: 6040
No movies: 3706

    \end{Verbatim}

    Thống kê mô tả số tần suất rating của các users:

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}3}]:} \PY{n}{movie\PYZus{}length}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{user\PYZus{}id}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{o}{.}\PY{n}{value\PYZus{}counts}\PY{p}{(}\PY{p}{)}\PY{o}{.}\PY{n}{describe}\PY{p}{(}\PY{p}{)}
\end{Verbatim}

            \begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}3}]:} count    6040.000000
        mean      165.597351
        std       192.747126
        min        20.000000
        25\%        44.000000
        50\%        96.000000
        75\%       208.000000
        max      2314.000000
        Name: user\_id, dtype: float64
\end{Verbatim}
        
    \begin{itemize}
\tightlist
\item
  Bình quân một user rate tổng cộng 165 bộ phim.
\item
  User thấp nhất rate 20 bộ phim và user nhiều nhất rate 2314 bộ phim.
\item
  Khoảng số lượng bộ phim rating phổ biến của một user là từ 44 bộ tới
  208 bộ phim (chiếm 50\%).
\end{itemize}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}4}]:} \PY{k+kn}{import} \PY{n+nn}{matplotlib}\PY{n+nn}{.}\PY{n+nn}{pyplot} \PY{k}{as} \PY{n+nn}{plt}
        \PY{o}{\PYZpc{}}\PY{k}{matplotlib} inline
        \PY{n}{movie\PYZus{}length}\PY{p}{[}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{user\PYZus{}id}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{item\PYZus{}id}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{]}\PY{o}{.}\PY{n}{groupby}\PY{p}{(}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{user\PYZus{}id}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{)}\PY{o}{.}\PY{n}{count}\PY{p}{(}\PY{p}{)}\PY{o}{.}\PYZbs{}
        \PY{n}{hist}\PY{p}{(}\PY{n}{bins} \PY{o}{=} \PY{l+m+mi}{20}\PY{p}{,} \PY{n}{figsize} \PY{o}{=} \PY{p}{(}\PY{l+m+mi}{12}\PY{p}{,} \PY{l+m+mi}{8}\PY{p}{)}\PY{p}{)}
        \PY{n}{plt}\PY{o}{.}\PY{n}{title}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Distribution of no ratings by each customer}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
        \PY{n}{plt}\PY{o}{.}\PY{n}{xlabel}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{No ratings}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
        \PY{n}{plt}\PY{o}{.}\PY{n}{ylabel}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{No customers}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
\end{Verbatim}

            \begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}4}]:} Text(0,0.5,'No customers')
\end{Verbatim}
        
    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{MatrixFactorization_files/MatrixFactorization_7_1.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    Nhìn vào phân bố của số lượng user theo mức độ rating ta có thể thấy mẫu
của chúng ta có hiện tượng không cân bằng khi có nhiều user rating rất
ít và nhiều user rating nhiều hơn. Tuy nhiên đây không phải là bài toán
classification nên việc mẫu có kích thước mất cân bằng cũng không ảnh
hưởng tới mức độ chính xác của thuật toán. Hơn nữa thuật toán
\texttt{matrix\ factorization} xây dựng hàm loss function riêng lẻ cho
từng user nêu việc user này rating bao nhiêu sản phẩm không ảnh hưởng
đến kết quả dự báo rating của user khác. Hoàn toàn tương tự ta cũng
thống kê được số lượng các user rating đối với từng bộ phim.

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}5}]:} \PY{n}{movie\PYZus{}length}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{item\PYZus{}id}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{o}{.}\PY{n}{value\PYZus{}counts}\PY{p}{(}\PY{p}{)}\PY{o}{.}\PY{n}{describe}\PY{p}{(}\PY{p}{)}
\end{Verbatim}

            \begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}5}]:} count    3706.000000
        mean      269.888829
        std       384.046815
        min         1.000000
        25\%        33.000000
        50\%       123.500000
        75\%       350.000000
        max      3428.000000
        Name: item\_id, dtype: float64
\end{Verbatim}
        
    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}6}]:} \PY{n}{movie\PYZus{}length}\PY{p}{[}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{user\PYZus{}id}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{item\PYZus{}id}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{]}\PY{o}{.}\PY{n}{groupby}\PY{p}{(}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{item\PYZus{}id}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{)}\PY{o}{.}\PY{n}{count}\PY{p}{(}\PY{p}{)}\PY{o}{.}\PYZbs{}
        \PY{n}{hist}\PY{p}{(}\PY{n}{bins} \PY{o}{=} \PY{l+m+mi}{20}\PY{p}{,} \PY{n}{figsize} \PY{o}{=} \PY{p}{(}\PY{l+m+mi}{12}\PY{p}{,} \PY{l+m+mi}{8}\PY{p}{)}\PY{p}{)}
        \PY{n}{plt}\PY{o}{.}\PY{n}{title}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Distribution of no ratings per each movie}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
        \PY{n}{plt}\PY{o}{.}\PY{n}{xlabel}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{No ratings}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
        \PY{n}{plt}\PY{o}{.}\PY{n}{ylabel}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{No movies}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
\end{Verbatim}

            \begin{Verbatim}[commandchars=\\\{\}]
{\color{outcolor}Out[{\color{outcolor}6}]:} Text(0,0.5,'No movies')
\end{Verbatim}
        
    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{MatrixFactorization_files/MatrixFactorization_10_1.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    Một vài đánh giá: * Số lần 1 bộ phim được rating ít nhất là 1 lần. * Số
lần 1 bộ phim được rating nhiều nhất là 3428 lần. * Mức độ rating phổ
biến của một bộ phim là từ 33 đến 123 lần.

\subsection{2.2. Thuật toán matrix
factorization}\label{thuux1eadt-touxe1n-matrix-factorization}

\subsubsection{2.2.1. Các hàm trong thuật
toán}\label{cuxe1c-huxe0m-trong-thuux1eadt-touxe1n}

Đầu tiên ta sẽ tiến hành chia mẫu train và test theo tỷ lệ sao cho số
lượng rating trong tập train chiếm 2/3 số lượng các lượt rating. Cách
chia mẫu hợp lý nhất là đảm bảo tỷ lệ số lượng ratings xuất hiện trong
tập train đối với số lượng ratings xuất hiện trong tập test của cùng một
user là bằng nhau. Cách chia này đảm bảo sự công bằng đối với các user
khi không có user nào có quá nhiều dữ liệu train và dữ liệu test ít hoặc
dữ liệu train quá ít nhưng dữ liệu test lại quá nhiều. Giá trị được dự
báo từ mô hình mà dữ liệu train quá ít sẽ thường không chuẩn xác và làm
sai lệch kết quả kiểm tra sai số trên test.

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}7}]:} \PY{c+c1}{\PYZsh{}declare split\PYZus{}rate for train/total ratings}
        \PY{n}{split\PYZus{}rate} \PY{o}{=} \PY{l+m+mi}{2}\PY{o}{/}\PY{l+m+mi}{3}
        
        \PY{k}{def} \PY{n+nf}{split\PYZus{}train\PYZus{}test}\PY{p}{(}\PY{n}{dataset}\PY{p}{)}\PY{p}{:}
            \PY{n}{gb} \PY{o}{=} \PY{n}{dataset}\PY{o}{.}\PY{n}{groupby}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{user\PYZus{}id}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
            \PY{n}{ls} \PY{o}{=} \PY{p}{[}\PY{n}{gb}\PY{o}{.}\PY{n}{get\PYZus{}group}\PY{p}{(}\PY{n}{x}\PY{p}{)} \PY{k}{for} \PY{n}{x} \PY{o+ow}{in} \PY{n}{gb}\PY{o}{.}\PY{n}{groups}\PY{p}{]}
            \PY{n}{items} \PY{o}{=} \PY{p}{[}\PY{n}{x} \PY{k}{for} \PY{n}{x} \PY{o+ow}{in} \PY{n}{gb}\PY{o}{.}\PY{n}{groups}\PY{p}{]}
            \PY{n}{index\PYZus{}size} \PY{o}{=} \PY{p}{[}\PY{p}{\PYZob{}}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{i}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n}{i}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{index}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:}\PY{n}{gb}\PY{o}{.}\PY{n}{groups}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{size}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:}\PY{n+nb}{len}\PY{p}{(}\PY{n}{gb}\PY{o}{.}\PY{n}{groups}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{)}\PY{p}{\PYZcb{}} \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n}{items}\PY{p}{]}
            \PY{n}{index\PYZus{}train} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{Int64Index}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{)}
            \PY{n}{index\PYZus{}test} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{Int64Index}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{)}
            \PY{k}{for} \PY{n}{x} \PY{o+ow}{in} \PY{n}{index\PYZus{}size}\PY{p}{:}
                \PY{n}{np}\PY{o}{.}\PY{n}{random}\PY{o}{.}\PY{n}{shuffle}\PY{p}{(}\PY{n}{x}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{index}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{o}{.}\PY{n}{values}\PY{p}{)}
                \PY{n}{le} \PY{o}{=} \PY{n+nb}{int}\PY{p}{(}\PY{n}{x}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{size}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{o}{*}\PY{n}{split\PYZus{}rate}\PY{p}{)}
                \PY{n}{index\PYZus{}train} \PY{o}{=} \PY{n}{index\PYZus{}train}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{x}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{index}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{[}\PY{p}{:}\PY{n}{le}\PY{p}{]}\PY{p}{)}
                \PY{n}{index\PYZus{}test} \PY{o}{=} \PY{n}{index\PYZus{}test}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{x}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{index}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{[}\PY{n}{le}\PY{p}{:}\PY{p}{]}\PY{p}{)}
            \PY{n}{train} \PY{o}{=} \PY{n}{dataset}\PY{o}{.}\PY{n}{iloc}\PY{p}{[}\PY{n}{index\PYZus{}train}\PY{p}{]}\PY{o}{.}\PY{n}{values}
            \PY{n}{test} \PY{o}{=} \PY{n}{dataset}\PY{o}{.}\PY{n}{iloc}\PY{p}{[}\PY{n}{index\PYZus{}test}\PY{p}{]}\PY{o}{.}\PY{n}{values}
            \PY{c+c1}{\PYZsh{}minus id to 1 to index start from 0}
            \PY{n}{train}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{]} \PY{o}{\PYZhy{}}\PY{o}{=} \PY{l+m+mi}{1}
            \PY{n}{train}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{]} \PY{o}{\PYZhy{}}\PY{o}{=} \PY{l+m+mi}{1}
            \PY{n}{test}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{]} \PY{o}{\PYZhy{}}\PY{o}{=} \PY{l+m+mi}{1}
            \PY{n}{test}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{]} \PY{o}{\PYZhy{}}\PY{o}{=} \PY{l+m+mi}{1}
            \PY{k}{return} \PY{n}{train}\PY{p}{,} \PY{n}{test}
        
        \PY{n}{train}\PY{p}{,} \PY{n}{test} \PY{o}{=} \PY{n}{split\PYZus{}train\PYZus{}test}\PY{p}{(}\PY{n}{movie\PYZus{}length}\PY{p}{)}
\end{Verbatim}

    \textbf{Tiến hành xây dựng thuật toán:}

Các biến chính cho thuật toán dữ báo bao gồm: * n\_users: Số lượng user
(chính là \(N\) trong thuật toán). * n\_items: Số lượng item (chính là
\(M\) trong thuật toán). * K: Số lượng nhân tố ẩn được sử dụng (giá trị
\(K\) trong thuật toán). * theta: Tham số \(\theta\) để cập nhật hệ số
trong thuật toán gradient descent. * split\_rate: Tỷ lệ chia mẫu
train/test. * lamda: Tham số hiệu chỉnh của thành phần hiệu chỉnh
\texttt{l2\ -\ regularization} (Để đơn giản thiết lập
\(\lambda_1 = \lambda_2\)). * I: Ma trận sản phẩm. * U: Ma trận người
dùng.

Lưu ý rằng các ma trận \(\mathbf{I}, \mathbf{U}\) được xây dựng dựa trên
các \emph{nhân tố ẩn} (latent feature) nên ban đầu ta chưa xác định được
các nhân tố này và phải khởi tạo giá trị ngẫu nhiên cho chúng. Số lượng
nhân tố ẩn \(K\) là một giá trị tùy ý ta có thể lựa chọn. Theo
\href{https://datajobs.com/data-science-repo/Recommender-Systems-\%5BNetflix\%5D.pdf}{Matrix
Factorization For Recommendation System} thì khi số lượng nhân tố ẩn
càng nhiều thuật toán càng chính xác hơn nhưng cũng làm gia tăng chi phí
tính toán. Đồng thời những mô hình được xây dựng dựa trên nhân tố ẩn đã
được tinh luyện để có mức độ khác biệt lớn cũng đưa ra kết quả chính xác
hơn các việc tạo ra các nhân tố ẩn ngẫu nhiên.

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}8}]:} \PY{n}{n\PYZus{}users} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{max}\PY{p}{(}\PY{n}{train}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{]} \PY{o}{+} \PY{l+m+mi}{1}\PY{p}{)} \PY{c+c1}{\PYZsh{}plus one because index start from 0}
        \PY{n}{n\PYZus{}items} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{max}\PY{p}{(}\PY{n}{train}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{]} \PY{o}{+} \PY{l+m+mi}{1}\PY{p}{)}
        \PY{n}{n\PYZus{}ratings} \PY{o}{=} \PY{n}{train}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}
        \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{N user dimesion: }\PY{l+s+si}{\PYZpc{}s}\PY{l+s+s1}{\PYZsq{}}\PY{o}{\PYZpc{}}\PY{k}{n\PYZus{}users})
        \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{M item dimesion: }\PY{l+s+si}{\PYZpc{}s}\PY{l+s+s1}{\PYZsq{}}\PY{o}{\PYZpc{}}\PY{k}{n\PYZus{}items})
        \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{S Number of rating: }\PY{l+s+si}{\PYZpc{}s}\PY{l+s+s1}{\PYZsq{}}\PY{o}{\PYZpc{}}\PY{k}{n\PYZus{}ratings})
        \PY{n}{K} \PY{o}{=} \PY{l+m+mi}{2}
        \PY{n}{theta} \PY{o}{=} \PY{l+m+mf}{0.75}
        \PY{n}{lamda} \PY{o}{=} \PY{l+m+mf}{0.2}
        \PY{c+c1}{\PYZsh{}Inititalize random matrix according to Gauss distribution}
        \PY{n}{I} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{random}\PY{o}{.}\PY{n}{randn}\PY{p}{(}\PY{n}{n\PYZus{}items}\PY{p}{,} \PY{n}{K}\PY{p}{)}
        \PY{n}{U} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{random}\PY{o}{.}\PY{n}{randn}\PY{p}{(}\PY{n}{K}\PY{p}{,} \PY{n}{n\PYZus{}users}\PY{p}{)}
\end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\}]
N user dimesion: 6040
M item dimesion: 3952
S Number of rating: 664826

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}9}]:} \PY{k+kn}{import} \PY{n+nn}{scipy}\PY{n+nn}{.}\PY{n+nn}{sparse} \PY{k}{as} \PY{n+nn}{sparse}
        \PY{c+c1}{\PYZsh{}Rating matrix}
        \PY{n}{Y} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{n}{shape} \PY{o}{=} \PY{p}{(}\PY{n}{n\PYZus{}items}\PY{p}{,} \PY{n}{n\PYZus{}users}\PY{p}{)}\PY{p}{)}
        \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Y utility matrix shape: }\PY{l+s+si}{\PYZpc{}s}\PY{l+s+s1}{\PYZsq{}}\PY{o}{\PYZpc{}}\PY{k}{str}(Y.shape))
        \PY{n}{Y} \PY{o}{=} \PY{n}{sparse}\PY{o}{.}\PY{n}{coo\PYZus{}matrix}\PY{p}{(}\PY{p}{(}\PY{n}{train}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{2}\PY{p}{]}\PY{p}{,} \PY{p}{(}\PY{n}{train}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} \PY{n}{train}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}\PY{p}{)}\PY{p}{,}\PYZbs{}
                              \PY{n}{shape} \PY{o}{=} \PY{p}{(}\PY{n}{n\PYZus{}items}\PY{p}{,} \PY{n}{n\PYZus{}users}\PY{p}{)}\PY{p}{,} \PY{n}{dtype} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float}\PY{p}{)}\PY{o}{.}\PY{n}{toarray}\PY{p}{(}\PY{p}{)}
\end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\}]
Y utility matrix shape: (3952, 6040)

    \end{Verbatim}

    Không phải hoàn toàn các giá trị trên ma trận \(\mathbf{Y}\) đều được
rating. Vì vậy ma trận \(\mathbf{R}\) được tạo ra nhằm đánh dấu các vị
trí được rating của \(\mathbf{Y}\) bằng giá trị 1 và chưa được rating
bằng 0.

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}10}]:} \PY{n}{R} \PY{o}{=} \PY{n}{sparse}\PY{o}{.}\PY{n}{coo\PYZus{}matrix}\PY{p}{(}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{ones}\PY{p}{(}\PY{p}{(}\PY{n}{n\PYZus{}ratings}\PY{p}{,}\PY{p}{)}\PY{p}{)}\PY{p}{,} \PY{p}{(}\PY{n}{train}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} \PY{n}{train}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}\PY{p}{)}\PY{p}{,}\PYZbs{}
                               \PY{n}{shape} \PY{o}{=} \PY{p}{(}\PY{n}{n\PYZus{}items}\PY{p}{,} \PY{n}{n\PYZus{}users}\PY{p}{)}\PY{p}{)}\PY{o}{.}\PY{n}{toarray}\PY{p}{(}\PY{p}{)}
\end{Verbatim}

    Để thuật toán \texttt{gradient\ descent} hội tụ nhanh hơn chúng ta cần
chuẩn hóa ma trận \(\mathbf{Y}\) về giá trị kì vọng bằng 0 bằng cách trừ
đi mỗi giá trị rating trong vector rating của một user với trung bình
của vector rating đó.

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}11}]:} \PY{k}{def} \PY{n+nf}{standardize\PYZus{}Y}\PY{p}{(}\PY{n}{Y}\PY{p}{)}\PY{p}{:}
             \PY{n}{sum\PYZus{}rating} \PY{o}{=} \PY{n}{Y}\PY{o}{.}\PY{n}{sum}\PY{p}{(}\PY{n}{axis} \PY{o}{=} \PY{l+m+mi}{0}\PY{p}{)}
             \PY{n}{u\PYZus{}rating} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{count\PYZus{}nonzero}\PY{p}{(}\PY{n}{Y}\PY{p}{,} \PY{n}{axis} \PY{o}{=} \PY{l+m+mi}{0}\PY{p}{)}
             \PY{n}{u\PYZus{}mean} \PY{o}{=} \PY{n}{sum\PYZus{}rating}\PY{o}{/}\PY{n}{u\PYZus{}rating}
             \PY{k}{for} \PY{n}{n} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{n\PYZus{}users}\PY{p}{)}\PY{p}{:}
                 \PY{k}{for} \PY{n}{m} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{n\PYZus{}items}\PY{p}{)}\PY{p}{:}
                     \PY{k}{if} \PY{n}{Y}\PY{p}{[}\PY{n}{m}\PY{p}{,} \PY{n}{n}\PY{p}{]} \PY{o}{!=} \PY{l+m+mi}{0}\PY{p}{:}
                         \PY{n}{Y}\PY{p}{[}\PY{n}{m}\PY{p}{,} \PY{n}{n}\PY{p}{]} \PY{o}{\PYZhy{}}\PY{o}{=} \PY{n}{u\PYZus{}mean}\PY{p}{[}\PY{n}{n}\PY{p}{]}
             \PY{k}{return} \PY{n}{Y}\PY{p}{,} \PY{n}{u\PYZus{}mean}
         
         \PY{n}{Y\PYZus{}stad}\PY{p}{,} \PY{n}{u\PYZus{}mean} \PY{o}{=} \PY{n}{standardize\PYZus{}Y}\PY{p}{(}\PY{n}{Y}\PY{p}{)}
\end{Verbatim}

    Sau khi chuẩn hóa ma trận \(\mathbf{Y}\) thì phần quan trọng nhất là áp
dụng thuật toán \texttt{gradient\ descent} để tối ưu hóa các hệ số của
ma trận \(\mathbf{U}, \mathbf{I}\). Dựa trên lý thuyết về thuật toán đã
xây dựng ở mục \textbf{1.4} để xây dựng các hàm số update ma trận:

\textbf{Thuật toán gradient descent cho ma trận người dùng:}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}12}]:} \PY{k}{def} \PY{n+nf}{updateU}\PY{p}{(}\PY{n}{U}\PY{p}{)}\PY{p}{:}
             \PY{k}{for} \PY{n}{n} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{n\PYZus{}users}\PY{p}{)}\PY{p}{:}
             \PY{c+c1}{\PYZsh{} Matrix items include all items is rated by user n}
                 \PY{n}{i\PYZus{}rated} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{where}\PY{p}{(}\PY{n}{Y\PYZus{}stad}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{n}{n}\PY{p}{]} \PY{o}{!=} \PY{l+m+mi}{0}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{c+c1}{\PYZsh{}item\PYZsq{}s index rated by n}
                 \PY{n}{In} \PY{o}{=} \PY{n}{I}\PY{p}{[}\PY{n}{i\PYZus{}rated}\PY{p}{,} \PY{p}{:}\PY{p}{]}
                 \PY{k}{if} \PY{n}{In}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{==} \PY{l+m+mi}{0}\PY{p}{:}
                     \PY{n}{U}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{n}{n}\PY{p}{]} \PY{o}{=} \PY{l+m+mi}{0}
                 \PY{k}{else}\PY{p}{:} 
                     \PY{n}{s} \PY{o}{=} \PY{n}{In}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}
                     \PY{n}{u\PYZus{}n} \PY{o}{=} \PY{n}{U}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{n}{n}\PY{p}{]}
                     \PY{n}{y\PYZus{}n} \PY{o}{=} \PY{n}{Y\PYZus{}stad}\PY{p}{[}\PY{n}{i\PYZus{}rated}\PY{p}{,} \PY{n}{n}\PY{p}{]}
                     \PY{n}{grad} \PY{o}{=} \PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{o}{/}\PY{n}{s} \PY{o}{*} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{In}\PY{o}{.}\PY{n}{T}\PY{p}{,}\PY{p}{(}\PY{n}{y\PYZus{}n}\PY{o}{\PYZhy{}}\PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{In}\PY{p}{,} \PY{n}{u\PYZus{}n}\PY{p}{)}\PY{p}{)}\PY{p}{)} \PY{o}{+} \PY{n}{lamda}\PY{o}{*}\PY{n}{u\PYZus{}n}
                     \PY{n}{U}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{n}{n}\PY{p}{]} \PY{o}{\PYZhy{}}\PY{o}{=} \PY{n}{theta}\PY{o}{*}\PY{n}{grad}
             \PY{k}{return} \PY{n}{U}
\end{Verbatim}

    \textbf{Thuật toán gradient descent cho ma trận sản phẩm:}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}13}]:} \PY{k}{def} \PY{n+nf}{updateI}\PY{p}{(}\PY{n}{I}\PY{p}{)}\PY{p}{:}
             \PY{k}{for} \PY{n}{m} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{n\PYZus{}items}\PY{p}{)}\PY{p}{:}
             \PY{c+c1}{\PYZsh{} Matrix users who rated into item m}
                 \PY{n}{i\PYZus{}rated} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{where}\PY{p}{(}\PY{n}{Y\PYZus{}stad}\PY{p}{[}\PY{n}{m}\PY{p}{,} \PY{p}{:}\PY{p}{]} \PY{o}{!=} \PY{l+m+mi}{0}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{c+c1}{\PYZsh{}user\PYZsq{}s index rated into m}
                 \PY{n}{Um} \PY{o}{=} \PY{n}{U}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{n}{i\PYZus{}rated}\PY{p}{]}
                 \PY{k}{if} \PY{n}{Um}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{==} \PY{l+m+mi}{0}\PY{p}{:} 
                     \PY{n}{I}\PY{p}{[}\PY{n}{m}\PY{p}{,} \PY{p}{:}\PY{p}{]} \PY{o}{=} \PY{l+m+mi}{0}
                 \PY{k}{else}\PY{p}{:}
                     \PY{n}{s} \PY{o}{=} \PY{n}{Um}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}
                     \PY{n}{i\PYZus{}m} \PY{o}{=} \PY{n}{I}\PY{p}{[}\PY{n}{m}\PY{p}{,} \PY{p}{:}\PY{p}{]}
                     \PY{n}{y\PYZus{}m} \PY{o}{=} \PY{n}{Y\PYZus{}stad}\PY{p}{[}\PY{n}{m}\PY{p}{,} \PY{n}{i\PYZus{}rated}\PY{p}{]}
                     \PY{n}{grad} \PY{o}{=} \PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{o}{/}\PY{n}{s} \PY{o}{*} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{y\PYZus{}m} \PY{o}{\PYZhy{}} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{i\PYZus{}m}\PY{p}{,} \PY{n}{Um}\PY{p}{)}\PY{p}{,} \PY{n}{Um}\PY{o}{.}\PY{n}{T}\PY{p}{)} \PY{o}{+} \PY{n}{lamda}\PY{o}{*}\PY{n}{i\PYZus{}m}
                     \PY{n}{I}\PY{p}{[}\PY{n}{m}\PY{p}{,} \PY{p}{:}\PY{p}{]} \PY{o}{\PYZhy{}}\PY{o}{=} \PY{n}{theta}\PY{o}{*}\PY{n}{grad}
             \PY{k}{return} \PY{n}{I}
\end{Verbatim}

    \textbf{Xây dựng hàm dự báo ma trận \(\mathbf{Y}\):}

Dựa trên ma trận \(\mathbf{U}\) và \(\mathbf{I}\) ta có thể tính toán ma
trận dự báo của \(\mathbf{Y}\) là \(\mathbf{\hat{Y}}\) theo công thức
\emph{(1.4.0)} và xây dựng được hàm \emph{pred()}. Các kết quả dự báo
cần được chuyển hóa ngược lại rating bằng cách cộng thêm trung bình
rating của mỗi user vào các giá trị ratings thuộc cùng 1 user. Một số
kết quả sẽ vượt quá miền giá trị của rating là {[}1, 5{]} và khi đó sẽ
được gán lại về 2 đầu mút 1 hoặc 5. Ma trận thu được sẽ thỏa mãn tại một
ô của \(\mathbf{\hat{Y}}\) là kết quả dự báo rating của người dùng đối
với sản phẩm tương ứng. Do ta chỉ cần đánh giá trận \(\mathbf{Y}\) trên
những cặp (user,item) đã được rating nên trong hàm
\emph{pred\_train\_test()} ta cần dựa vào ma trận rating \(\mathbf{R}\)
để thay thế những vị trí chưa được rating bằng 0. Lý do hàm số này được
đặt tên là \emph{pred\_train\_test()} đó là chúng ta cũng có thể thực
hiện tương tự cho tập test khi thay thế giá trị chưa rating bằng 0.

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}14}]:} \PY{k}{def} \PY{n+nf}{pred}\PY{p}{(}\PY{n}{U}\PY{p}{,} \PY{n}{I}\PY{p}{)}\PY{p}{:}
             \PY{c+c1}{\PYZsh{}predict utility matrix base on formula Y\PYZus{}hat = I.U}
             \PY{n}{Y\PYZus{}hat} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{I}\PY{p}{,} \PY{n}{U}\PY{p}{)}
             \PY{c+c1}{\PYZsh{}invert to forecast values by plus user\PYZsq{}s mean ratings}
             \PY{k}{for} \PY{n}{n} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{n\PYZus{}users}\PY{p}{)}\PY{p}{:}
                 \PY{n}{Y\PYZus{}hat}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{n}{n}\PY{p}{]} \PY{o}{+}\PY{o}{=} \PY{n}{u\PYZus{}mean}\PY{p}{[}\PY{n}{n}\PY{p}{]}
             \PY{c+c1}{\PYZsh{}convert to interger values because of rating is integer}
             \PY{n}{Y\PYZus{}hat} \PY{o}{=} \PY{n}{Y\PYZus{}hat}\PY{o}{.}\PY{n}{astype}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{int32}\PY{p}{)} 
             \PY{c+c1}{\PYZsh{}replace values \PYZgt{} 5 by 5 and values \PYZlt{} 1 by 1}
             \PY{n}{Y\PYZus{}hat}\PY{p}{[}\PY{n}{Y\PYZus{}hat} \PY{o}{\PYZgt{}} \PY{l+m+mi}{5}\PY{p}{]} \PY{o}{=} \PY{l+m+mi}{5}
             \PY{n}{Y\PYZus{}hat}\PY{p}{[}\PY{n}{Y\PYZus{}hat} \PY{o}{\PYZlt{}} \PY{l+m+mi}{1}\PY{p}{]} \PY{o}{=} \PY{l+m+mi}{1}
             \PY{k}{return} \PY{n}{Y\PYZus{}hat}
         
         \PY{k}{def} \PY{n+nf}{pred\PYZus{}train\PYZus{}test}\PY{p}{(}\PY{n}{Y\PYZus{}hat}\PY{p}{,} \PY{n}{R}\PY{p}{)}\PY{p}{:}
             \PY{c+c1}{\PYZsh{}replace values have not yet rated by 0 }
             \PY{n}{Y\PYZus{}pred} \PY{o}{=} \PY{n}{Y\PYZus{}hat}\PY{o}{.}\PY{n}{copy}\PY{p}{(}\PY{p}{)}
             \PY{n}{Y\PYZus{}pred}\PY{p}{[}\PY{n}{R} \PY{o}{==} \PY{l+m+mi}{0}\PY{p}{]} \PY{o}{=} \PY{l+m+mi}{0}
             \PY{k}{return} \PY{n}{Y\PYZus{}pred}
\end{Verbatim}

    \textbf{Xây dựng hàm loss function:}

Hàm loss function được xây dựng dựa trên công thức \emph{(1.4.1)} như
sau:

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}15}]:} \PY{k}{def} \PY{n+nf}{loss}\PY{p}{(}\PY{n}{Y}\PY{p}{,} \PY{n}{Y\PYZus{}hat}\PY{p}{)}\PY{p}{:}
             \PY{n}{error} \PY{o}{=} \PY{n}{Y}\PY{o}{\PYZhy{}}\PY{n}{Y\PYZus{}hat}
             \PY{n}{loss\PYZus{}value} \PY{o}{=} \PY{l+m+mi}{1}\PY{o}{/}\PY{p}{(}\PY{l+m+mi}{2}\PY{o}{*}\PY{n}{n\PYZus{}ratings}\PY{p}{)}\PY{o}{*}\PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{norm}\PY{p}{(}\PY{n}{error}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{fro}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2} \PY{o}{+} \PYZbs{}
             \PY{n}{lamda}\PY{o}{/}\PY{l+m+mi}{2}\PY{o}{*}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{norm}\PY{p}{(}\PY{n}{I}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{fro}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2} \PY{o}{+} \PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{norm}\PY{p}{(}\PY{n}{U}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{fro}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{)}
             \PY{k}{return} \PY{n}{loss\PYZus{}value}
\end{Verbatim}

    Sử dụng ma trận \(\mathbf{\hat{Y}}\) để dự báo trên tập test

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}16}]:} \PY{n}{Y\PYZus{}test} \PY{o}{=} \PY{n}{sparse}\PY{o}{.}\PY{n}{coo\PYZus{}matrix}\PY{p}{(}\PY{p}{(}\PY{n}{test}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{2}\PY{p}{]}\PY{p}{,} \PY{p}{(}\PY{n}{test}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} \PY{n}{test}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}\PY{p}{)}\PY{p}{,} \PYZbs{}
                                    \PY{n}{shape} \PY{o}{=} \PY{p}{(}\PY{n}{n\PYZus{}items}\PY{p}{,} \PY{n}{n\PYZus{}users}\PY{p}{)}\PY{p}{,} \PY{n}{dtype} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float}\PY{p}{)}\PY{o}{.}\PY{n}{toarray}\PY{p}{(}\PY{p}{)}
         \PY{n}{R\PYZus{}test} \PY{o}{=} \PY{n}{sparse}\PY{o}{.}\PY{n}{coo\PYZus{}matrix}\PY{p}{(}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{ones}\PY{p}{(}\PY{n}{test}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}\PY{p}{,} \PY{p}{(}\PY{n}{test}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} \PY{n}{test}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}\PY{p}{)}\PY{p}{,} \PYZbs{}
                                    \PY{n}{shape} \PY{o}{=} \PY{p}{(}\PY{n}{n\PYZus{}items}\PY{p}{,} \PY{n}{n\PYZus{}users}\PY{p}{)}\PY{p}{,} \PY{n}{dtype} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float}\PY{p}{)}\PY{o}{.}\PY{n}{toarray}\PY{p}{(}\PY{p}{)}
\end{Verbatim}

    \textbf{Xây dựng hàm tính RMSE:}

Sau khi tính được ma trận dự báo \(\mathbf{\hat{Y}}\) trên tập test kết
hợp với ma trận tiện ích \(\mathbf{Y}\) của tập test đã biết ta sẽ tính
được \emph{RMSE} trên tập test như sau:

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}17}]:} \PY{k+kn}{import} \PY{n+nn}{math}
         \PY{k}{def} \PY{n+nf}{RMSE}\PY{p}{(}\PY{n}{Y\PYZus{}test}\PY{p}{,} \PY{n}{Y\PYZus{}pred}\PY{p}{)}\PY{p}{:}
             \PY{n}{error} \PY{o}{=} \PY{n}{Y\PYZus{}test} \PY{o}{\PYZhy{}} \PY{n}{Y\PYZus{}pred}
             \PY{n}{n\PYZus{}ratings} \PY{o}{=} \PY{n}{test}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}
             \PY{n}{rmse} \PY{o}{=} \PY{n}{math}\PY{o}{.}\PY{n}{sqrt}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{norm}\PY{p}{(}\PY{n}{error}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{fro}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{o}{/}\PY{n}{n\PYZus{}ratings}\PY{p}{)}
             \PY{k}{return} \PY{n}{rmse}
\end{Verbatim}

    \textbf{Xây dựng vòng lặp tối ưu chính:}

Sau khi đã thiết kế được các hàm tính toán \emph{loss function, RMSE} và
các hàm tối ưu \emph{gradient descent} ta sẽ tiến hành xây dựng vòng lặp
tối ưu để cập nhật các ma trận \(\mathbf{U}\) và \(\mathbf{I}\) và đánh
giá hiệu quả của mỗi bước lặp thông qua giá trị của \emph{loss function}
và \emph{RMSE}.

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}19}]:} \PY{k}{def} \PY{n+nf}{fit}\PY{p}{(}\PY{n}{Umatrix}\PY{p}{,} \PY{n}{Imatrix}\PY{p}{,} \PY{n}{Ytrain}\PY{p}{,} \PY{n}{Ytest}\PY{p}{,} \PY{n}{n\PYZus{}iter}\PY{p}{,} \PY{n}{log\PYZus{}iter}\PY{p}{)}\PY{p}{:}
             \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{n\PYZus{}iter}\PY{p}{)}\PY{p}{:}
                 \PY{c+c1}{\PYZsh{}update U and I}
                 \PY{n}{Umatrix} \PY{o}{=} \PY{n}{updateU}\PY{p}{(}\PY{n}{Umatrix}\PY{p}{)}
                 \PY{n}{Imatrix} \PY{o}{=} \PY{n}{updateI}\PY{p}{(}\PY{n}{Imatrix}\PY{p}{)}
                 \PY{c+c1}{\PYZsh{}calculate Y\PYZus{}hat}
                 \PY{n}{Y\PYZus{}hat} \PY{o}{=} \PY{n}{pred}\PY{p}{(}\PY{n}{Umatrix}\PY{p}{,} \PY{n}{Imatrix}\PY{p}{)}
                 \PY{c+c1}{\PYZsh{}calculate Y\PYZus{}hat\PYZus{}train by replace non ratings by 0}
                 \PY{n}{Y\PYZus{}pred\PYZus{}train} \PY{o}{=} \PY{n}{pred\PYZus{}train\PYZus{}test}\PY{p}{(}\PY{n}{Y\PYZus{}hat}\PY{p}{,} \PY{n}{R}\PY{p}{)}
                 \PY{c+c1}{\PYZsh{}calculate loss function}
                 \PY{n}{loss\PYZus{}value} \PY{o}{=} \PY{n}{loss}\PY{p}{(}\PY{n}{Ytrain}\PY{p}{,} \PY{n}{Y\PYZus{}pred\PYZus{}train}\PY{p}{)}
                 \PY{c+c1}{\PYZsh{}calculate Y\PYZus{}pred on test dataset}
                 \PY{n}{Y\PYZus{}pred\PYZus{}test} \PY{o}{=} \PY{n}{pred\PYZus{}train\PYZus{}test}\PY{p}{(}\PY{n}{Y\PYZus{}hat}\PY{p}{,} \PY{n}{R\PYZus{}test}\PY{p}{)}
                 \PY{c+c1}{\PYZsh{}calculate RMSE}
                 \PY{n}{rmse} \PY{o}{=} \PY{n}{RMSE}\PY{p}{(}\PY{n}{Ytest}\PY{p}{,} \PY{n}{Y\PYZus{}pred\PYZus{}test}\PY{p}{)}
                 \PY{k}{if} \PY{n}{i} \PY{o}{\PYZpc{}} \PY{n}{log\PYZus{}iter} \PY{o}{==} \PY{l+m+mi}{0}\PY{p}{:}
                     \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Iteration: }\PY{l+s+si}{\PYZob{}\PYZcb{}}\PY{l+s+s1}{; RMSE: }\PY{l+s+si}{\PYZob{}\PYZcb{}}\PY{l+s+s1}{; Loss value: }\PY{l+s+si}{\PYZob{}\PYZcb{}}\PY{l+s+s1}{\PYZsq{}}\PY{o}{.}\PY{n}{format}\PY{p}{(}\PY{n}{i}\PY{p}{,} \PY{n}{rmse}\PY{p}{,} \PY{n}{loss\PYZus{}value}\PY{p}{)}\PY{p}{)}
             \PY{k}{return} \PY{n}{Y\PYZus{}hat}\PY{p}{,} \PY{n}{Y\PYZus{}pred\PYZus{}test}   
         \PY{n}{Y\PYZus{}hat}\PY{p}{,} \PY{n}{Y\PYZus{}pred} \PY{o}{=} \PY{n}{fit}\PY{p}{(}\PY{n}{Umatrix} \PY{o}{=} \PY{n}{U}\PY{p}{,} \PY{n}{Imatrix} \PY{o}{=} \PY{n}{I}\PY{p}{,} \PY{n}{Ytrain} \PY{o}{=} \PY{n}{Y}\PY{p}{,} \PY{n}{Ytest} \PY{o}{=} \PY{n}{Y\PYZus{}test}\PY{p}{,} \PY{n}{n\PYZus{}iter} \PY{o}{=} \PY{l+m+mi}{100}\PY{p}{,} \PY{n}{log\PYZus{}iter} \PY{o}{=} \PY{l+m+mi}{10}\PY{p}{)}
\end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\}]
Iteration: 0; RMSE: 1.0978996819873132; Loss value: 367.43589641528513
Iteration: 10; RMSE: 1.0972517727989382; Loss value: 371.61999405456453
Iteration: 20; RMSE: 1.0967013607569651; Loss value: 376.1721780533387
Iteration: 30; RMSE: 1.096062264477316; Loss value: 380.4612541939793
Iteration: 40; RMSE: 1.0953942145953313; Loss value: 384.2559773463809
Iteration: 50; RMSE: 1.0948442303904773; Loss value: 387.81426251576477
Iteration: 60; RMSE: 1.0945337212732151; Loss value: 390.15217556003586
Iteration: 70; RMSE: 1.0943198545615616; Loss value: 391.6867939243047
Iteration: 80; RMSE: 1.0941863369527691; Loss value: 392.6789203399845
Iteration: 90; RMSE: 1.0940269119371213; Loss value: 393.30221888979895

    \end{Verbatim}

    \subsubsection{2.2.2. Xây dựng class
MF}\label{xuxe2y-dux1ef1ng-class-mf}

Dựa trên các hàm đã xử lý ở \emph{(2.2.1)} ta sẽ thiết kế class MF có
chức năng xử lý dữ liệu, fiting model, đánh giá kết quả model và đưa ra
các recommend cho khách hàng về sản phẩm như sau:

\textbf{Class Data xử lý dữ liệu:}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}20}]:} \PY{k}{class} \PY{n+nc}{Data}\PY{p}{(}\PY{n+nb}{object}\PY{p}{)}\PY{p}{:}
             \PY{l+s+sd}{\PYZdq{}\PYZdq{}\PYZdq{}}
         \PY{l+s+sd}{    This class used to manage data.}
         \PY{l+s+sd}{    Two arguments:}
         \PY{l+s+sd}{    dataset: pandas data frame include user\PYZus{}id, item\PYZus{}id and rating}
         \PY{l+s+sd}{    split\PYZus{}rate: number train ratings/ total ratings}
         \PY{l+s+sd}{    \PYZdq{}\PYZdq{}\PYZdq{}}
             \PY{k}{def} \PY{n+nf}{\PYZus{}\PYZus{}init\PYZus{}\PYZus{}}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{,} \PY{n}{dataset}\PY{p}{,} \PY{n}{split\PYZus{}rate}\PY{p}{)}\PY{p}{:}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{dataset} \PY{o}{=} \PY{n}{dataset}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{split\PYZus{}rate} \PY{o}{=} \PY{n}{split\PYZus{}rate}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{train}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{test} \PY{o}{=} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{split\PYZus{}train\PYZus{}test}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{dataset}\PY{p}{)}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{Ytrain}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{Rtrain} \PY{o}{=} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{utility\PYZus{}matrix}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{train}\PY{p}{)}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{Ytest} \PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{Rtest}  \PY{o}{=} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{utility\PYZus{}matrix}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{test}\PY{p}{)}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{Ystad}\PY{p}{,}  \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{u\PYZus{}mean} \PY{o}{=} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{standardize\PYZus{}Y}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{Ytrain}\PY{p}{)}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{n\PYZus{}users} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{max}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{train}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{]} \PY{o}{+} \PY{l+m+mi}{1}\PY{p}{)} \PY{c+c1}{\PYZsh{}plus one because index start from 0}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{n\PYZus{}items} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{max}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{train}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{]} \PY{o}{+} \PY{l+m+mi}{1}\PY{p}{)}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{n\PYZus{}ratings} \PY{o}{=} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{train}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}
                 
             \PY{k}{def} \PY{n+nf}{split\PYZus{}train\PYZus{}test}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{,} \PY{n}{dataset}\PY{p}{)}\PY{p}{:}
                 \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{split train and test}\PY{l+s+s2}{\PYZdq{}}
                 \PY{n}{gb} \PY{o}{=} \PY{n}{dataset}\PY{o}{.}\PY{n}{groupby}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{user\PYZus{}id}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
                 \PY{n}{ls} \PY{o}{=} \PY{p}{[}\PY{n}{gb}\PY{o}{.}\PY{n}{get\PYZus{}group}\PY{p}{(}\PY{n}{x}\PY{p}{)} \PY{k}{for} \PY{n}{x} \PY{o+ow}{in} \PY{n}{gb}\PY{o}{.}\PY{n}{groups}\PY{p}{]}
                 \PY{n}{items} \PY{o}{=} \PY{p}{[}\PY{n}{x} \PY{k}{for} \PY{n}{x} \PY{o+ow}{in} \PY{n}{gb}\PY{o}{.}\PY{n}{groups}\PY{p}{]}
                 \PY{n}{index\PYZus{}size} \PY{o}{=} \PY{p}{[}\PY{p}{\PYZob{}}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{i}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{n}{i}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{index}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:}\PY{n}{gb}\PY{o}{.}\PY{n}{groups}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{size}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:}\PY{n+nb}{len}\PY{p}{(}\PY{n}{gb}\PY{o}{.}\PY{n}{groups}\PY{p}{[}\PY{n}{i}\PY{p}{]}\PY{p}{)}\PY{p}{\PYZcb{}} \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n}{items}\PY{p}{]}
                 \PY{n}{index\PYZus{}train} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{Int64Index}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{)}
                 \PY{n}{index\PYZus{}test} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{Int64Index}\PY{p}{(}\PY{p}{[}\PY{p}{]}\PY{p}{)}
                 \PY{k}{for} \PY{n}{x} \PY{o+ow}{in} \PY{n}{index\PYZus{}size}\PY{p}{:}
                     \PY{n}{np}\PY{o}{.}\PY{n}{random}\PY{o}{.}\PY{n}{shuffle}\PY{p}{(}\PY{n}{x}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{index}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{o}{.}\PY{n}{values}\PY{p}{)}
                     \PY{n}{le} \PY{o}{=} \PY{n+nb}{int}\PY{p}{(}\PY{n}{x}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{size}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{o}{*}\PY{n}{split\PYZus{}rate}\PY{p}{)}
                     \PY{n}{index\PYZus{}train} \PY{o}{=} \PY{n}{index\PYZus{}train}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{x}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{index}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{[}\PY{p}{:}\PY{n}{le}\PY{p}{]}\PY{p}{)}
                     \PY{n}{index\PYZus{}test} \PY{o}{=} \PY{n}{index\PYZus{}test}\PY{o}{.}\PY{n}{append}\PY{p}{(}\PY{n}{x}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{index}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{[}\PY{n}{le}\PY{p}{:}\PY{p}{]}\PY{p}{)}
                 \PY{n}{train} \PY{o}{=} \PY{n}{dataset}\PY{o}{.}\PY{n}{iloc}\PY{p}{[}\PY{n}{index\PYZus{}train}\PY{p}{]}\PY{o}{.}\PY{n}{values}
                 \PY{n}{test} \PY{o}{=} \PY{n}{dataset}\PY{o}{.}\PY{n}{iloc}\PY{p}{[}\PY{n}{index\PYZus{}test}\PY{p}{]}\PY{o}{.}\PY{n}{values}
                 \PY{c+c1}{\PYZsh{}minus id to 1 to index start from 0}
                 \PY{n}{train}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{]} \PY{o}{\PYZhy{}}\PY{o}{=} \PY{l+m+mi}{1}
                 \PY{n}{train}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{]} \PY{o}{\PYZhy{}}\PY{o}{=} \PY{l+m+mi}{1}
                 \PY{n}{test}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{]} \PY{o}{\PYZhy{}}\PY{o}{=} \PY{l+m+mi}{1}
                 \PY{n}{test}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{]} \PY{o}{\PYZhy{}}\PY{o}{=} \PY{l+m+mi}{1}
                 \PY{k}{return} \PY{n}{train}\PY{p}{,} \PY{n}{test}
             
             \PY{k}{def} \PY{n+nf}{utility\PYZus{}matrix}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{,} \PY{n}{data\PYZus{}mtx}\PY{p}{)}\PY{p}{:}
                 \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{create Y and R matrix}\PY{l+s+s2}{\PYZdq{}}
                 \PY{n}{Y} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{n}{shape} \PY{o}{=} \PY{p}{(}\PY{n}{n\PYZus{}items}\PY{p}{,} \PY{n}{n\PYZus{}users}\PY{p}{)}\PY{p}{)}
                 \PY{n}{Y} \PY{o}{=} \PY{n}{sparse}\PY{o}{.}\PY{n}{coo\PYZus{}matrix}\PY{p}{(}\PY{p}{(}\PY{n}{data\PYZus{}mtx}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{2}\PY{p}{]}\PY{p}{,} \PY{p}{(}\PY{n}{data\PYZus{}mtx}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} \PY{n}{data\PYZus{}mtx}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}\PY{p}{)}\PY{p}{,} \PYZbs{}
                                       \PY{n}{shape} \PY{o}{=} \PY{p}{(}\PY{n}{n\PYZus{}items}\PY{p}{,} \PY{n}{n\PYZus{}users}\PY{p}{)}\PY{p}{,} \PY{n}{dtype} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{float}\PY{p}{)}\PY{o}{.}\PY{n}{toarray}\PY{p}{(}\PY{p}{)}
                 \PY{n}{R} \PY{o}{=} \PY{n}{sparse}\PY{o}{.}\PY{n}{coo\PYZus{}matrix}\PY{p}{(}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{ones}\PY{p}{(}\PY{p}{(}\PY{n}{data\PYZus{}mtx}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,}\PY{p}{)}\PY{p}{)}\PY{p}{,} \PY{p}{(}\PY{n}{data\PYZus{}mtx}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{]}\PY{p}{,} \PY{n}{data\PYZus{}mtx}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}\PY{p}{)}\PY{p}{,} \PYZbs{}
                                       \PY{n}{shape} \PY{o}{=} \PY{p}{(}\PY{n}{n\PYZus{}items}\PY{p}{,} \PY{n}{n\PYZus{}users}\PY{p}{)}\PY{p}{)}\PY{o}{.}\PY{n}{toarray}\PY{p}{(}\PY{p}{)}
                 \PY{k}{return} \PY{n}{Y}\PY{p}{,} \PY{n}{R}
             
             \PY{k}{def} \PY{n+nf}{standardize\PYZus{}Y}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{,} \PY{n}{Y}\PY{p}{)}\PY{p}{:}
                 \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{standard data to mean ratings of each user = 0}\PY{l+s+s2}{\PYZdq{}}
                 \PY{n}{sum\PYZus{}rating} \PY{o}{=} \PY{n}{Y}\PY{o}{.}\PY{n}{sum}\PY{p}{(}\PY{n}{axis} \PY{o}{=} \PY{l+m+mi}{0}\PY{p}{)}
                 \PY{n}{u\PYZus{}rating} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{count\PYZus{}nonzero}\PY{p}{(}\PY{n}{Y}\PY{p}{,} \PY{n}{axis} \PY{o}{=} \PY{l+m+mi}{0}\PY{p}{)}
                 \PY{n}{u\PYZus{}mean} \PY{o}{=} \PY{n}{sum\PYZus{}rating}\PY{o}{/}\PY{n}{u\PYZus{}rating}
                 \PY{k}{for} \PY{n}{n} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{n\PYZus{}users}\PY{p}{)}\PY{p}{:}
                     \PY{k}{for} \PY{n}{m} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n}{n\PYZus{}items}\PY{p}{)}\PY{p}{:}
                         \PY{k}{if} \PY{n}{Y}\PY{p}{[}\PY{n}{m}\PY{p}{,} \PY{n}{n}\PY{p}{]} \PY{o}{!=} \PY{l+m+mi}{0}\PY{p}{:}
                             \PY{n}{Y}\PY{p}{[}\PY{n}{m}\PY{p}{,} \PY{n}{n}\PY{p}{]} \PY{o}{\PYZhy{}}\PY{o}{=} \PY{n}{u\PYZus{}mean}\PY{p}{[}\PY{n}{n}\PY{p}{]}
                 \PY{k}{return} \PY{n}{Y}\PY{p}{,} \PY{n}{u\PYZus{}mean}
\end{Verbatim}

    \textbf{Class model xây dựng và đánh giá model:}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}21}]:} \PY{k}{class} \PY{n+nc}{Model}\PY{p}{(}\PY{p}{)}\PY{p}{:}
             \PY{l+s+sd}{\PYZdq{}\PYZdq{}\PYZdq{}}
         \PY{l+s+sd}{    This class manage update U and I matrix, predict and evaluate error}
         \PY{l+s+sd}{    Four arguments:}
         \PY{l+s+sd}{    data: instance from Data class which supplies the data for model}
         \PY{l+s+sd}{    theta: learning rate}
         \PY{l+s+sd}{    lamda: regularization parameter}
         \PY{l+s+sd}{    K: number of latent factors}
         \PY{l+s+sd}{    \PYZdq{}\PYZdq{}\PYZdq{}}
             \PY{k}{def} \PY{n+nf}{\PYZus{}\PYZus{}init\PYZus{}\PYZus{}}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{,} \PY{n}{data}\PY{p}{,} \PY{n}{theta}\PY{p}{,} \PY{n}{lamda}\PY{p}{,} \PY{n}{K}\PY{p}{)}\PY{p}{:}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{data} \PY{o}{=} \PY{n}{data}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{theta} \PY{o}{=} \PY{n}{theta}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{lamda} \PY{o}{=} \PY{n}{lamda}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{K} \PY{o}{=} \PY{n}{K}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{I} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{random}\PY{o}{.}\PY{n}{randn}\PY{p}{(}\PY{n}{data}\PY{o}{.}\PY{n}{n\PYZus{}items}\PY{p}{,} \PY{n}{K}\PY{p}{)}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{U} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{random}\PY{o}{.}\PY{n}{randn}\PY{p}{(}\PY{n}{K}\PY{p}{,} \PY{n}{data}\PY{o}{.}\PY{n}{n\PYZus{}users}\PY{p}{)}
                 
                        
             \PY{k}{def} \PY{n+nf}{updateU}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{)}\PY{p}{:}
                 \PY{k}{for} \PY{n}{n} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{data}\PY{o}{.}\PY{n}{n\PYZus{}users}\PY{p}{)}\PY{p}{:}
                 \PY{c+c1}{\PYZsh{} Matrix items include all items is rated by user n}
                     \PY{n}{i\PYZus{}rated} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{where}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{data}\PY{o}{.}\PY{n}{Ystad}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{n}{n}\PY{p}{]} \PY{o}{!=} \PY{l+m+mi}{0}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{c+c1}{\PYZsh{}item\PYZsq{}s index rated by n}
                     \PY{n}{In} \PY{o}{=} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{I}\PY{p}{[}\PY{n}{i\PYZus{}rated}\PY{p}{,} \PY{p}{:}\PY{p}{]}
                     \PY{k}{if} \PY{n}{In}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{o}{==} \PY{l+m+mi}{0}\PY{p}{:}
                         \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{U}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{n}{n}\PY{p}{]} \PY{o}{=} \PY{l+m+mi}{0}
                     \PY{k}{else}\PY{p}{:} 
                         \PY{n}{s} \PY{o}{=} \PY{n}{In}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}
                         \PY{n}{u\PYZus{}n} \PY{o}{=} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{U}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{n}{n}\PY{p}{]}
                         \PY{n}{y\PYZus{}n} \PY{o}{=} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{data}\PY{o}{.}\PY{n}{Ystad}\PY{p}{[}\PY{n}{i\PYZus{}rated}\PY{p}{,} \PY{n}{n}\PY{p}{]}
                         \PY{n}{grad} \PY{o}{=} \PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{o}{/}\PY{n}{s} \PY{o}{*} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{In}\PY{o}{.}\PY{n}{T}\PY{p}{,}\PY{p}{(}\PY{n}{y\PYZus{}n}\PY{o}{\PYZhy{}}\PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{In}\PY{p}{,} \PY{n}{u\PYZus{}n}\PY{p}{)}\PY{p}{)}\PY{p}{)} \PY{o}{+} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{lamda}\PY{o}{*}\PY{n}{u\PYZus{}n}
                         \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{U}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{n}{n}\PY{p}{]} \PY{o}{\PYZhy{}}\PY{o}{=} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{theta}\PY{o}{*}\PY{n}{grad}
                  
             \PY{k}{def} \PY{n+nf}{updateI}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{)}\PY{p}{:}
                 \PY{k}{for} \PY{n}{m} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{data}\PY{o}{.}\PY{n}{n\PYZus{}items}\PY{p}{)}\PY{p}{:}
                 \PY{c+c1}{\PYZsh{} Matrix users who rated into item m}
                     \PY{n}{i\PYZus{}rated} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{where}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{data}\PY{o}{.}\PY{n}{Ystad}\PY{p}{[}\PY{n}{m}\PY{p}{,} \PY{p}{:}\PY{p}{]} \PY{o}{!=} \PY{l+m+mi}{0}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]} \PY{c+c1}{\PYZsh{}user\PYZsq{}s index rated into m}
                     \PY{n}{Um} \PY{o}{=} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{U}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{n}{i\PYZus{}rated}\PY{p}{]}
                     \PY{k}{if} \PY{n}{Um}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]} \PY{o}{==} \PY{l+m+mi}{0}\PY{p}{:} 
                         \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{I}\PY{p}{[}\PY{n}{m}\PY{p}{,} \PY{p}{:}\PY{p}{]} \PY{o}{=} \PY{l+m+mi}{0}
                     \PY{k}{else}\PY{p}{:}
                         \PY{n}{s} \PY{o}{=} \PY{n}{Um}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}
                         \PY{n}{i\PYZus{}m} \PY{o}{=} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{I}\PY{p}{[}\PY{n}{m}\PY{p}{,} \PY{p}{:}\PY{p}{]}
                         \PY{n}{y\PYZus{}m} \PY{o}{=} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{data}\PY{o}{.}\PY{n}{Ystad}\PY{p}{[}\PY{n}{m}\PY{p}{,} \PY{n}{i\PYZus{}rated}\PY{p}{]}
                         \PY{n}{grad} \PY{o}{=} \PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{o}{/}\PY{n}{s} \PY{o}{*} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{y\PYZus{}m} \PY{o}{\PYZhy{}} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{i\PYZus{}m}\PY{p}{,} \PY{n}{Um}\PY{p}{)}\PY{p}{,} \PY{n}{Um}\PY{o}{.}\PY{n}{T}\PY{p}{)} \PY{o}{+} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{lamda}\PY{o}{*}\PY{n}{i\PYZus{}m}
                         \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{I}\PY{p}{[}\PY{n}{m}\PY{p}{,} \PY{p}{:}\PY{p}{]} \PY{o}{\PYZhy{}}\PY{o}{=} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{theta}\PY{o}{*}\PY{n}{grad}
             
             \PY{k}{def} \PY{n+nf}{pred}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{,} \PY{n}{I}\PY{p}{,} \PY{n}{U}\PY{p}{)}\PY{p}{:}
                 \PY{c+c1}{\PYZsh{}predict utility matrix base on formula Yhat = I.U}
                 \PY{n}{Yhat} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{I}\PY{p}{,} \PY{n}{U}\PY{p}{)}
                 \PY{c+c1}{\PYZsh{}invert to forecast values by plus user\PYZsq{}s mean ratings}
                 \PY{k}{for} \PY{n}{n} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{data}\PY{o}{.}\PY{n}{n\PYZus{}users}\PY{p}{)}\PY{p}{:}
                     \PY{n}{Yhat}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{n}{n}\PY{p}{]} \PY{o}{+}\PY{o}{=} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{data}\PY{o}{.}\PY{n}{u\PYZus{}mean}\PY{p}{[}\PY{n}{n}\PY{p}{]}
                 \PY{c+c1}{\PYZsh{}convert to interger values because of rating is integer}
                 \PY{n}{Yhat} \PY{o}{=} \PY{n}{Yhat}\PY{o}{.}\PY{n}{astype}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{int32}\PY{p}{)} 
                 \PY{c+c1}{\PYZsh{}replace values \PYZgt{} 5 by 5 and values \PYZlt{} 1 by 1}
                 \PY{n}{Yhat}\PY{p}{[}\PY{n}{Yhat} \PY{o}{\PYZgt{}} \PY{l+m+mi}{5}\PY{p}{]} \PY{o}{=} \PY{l+m+mi}{5}
                 \PY{n}{Yhat}\PY{p}{[}\PY{n}{Yhat} \PY{o}{\PYZlt{}} \PY{l+m+mi}{1}\PY{p}{]} \PY{o}{=} \PY{l+m+mi}{1}
                 \PY{k}{return} \PY{n}{Yhat}
         
             \PY{k}{def} \PY{n+nf}{pred\PYZus{}train\PYZus{}test}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{,} \PY{n}{Yhat}\PY{p}{,} \PY{n}{R}\PY{p}{)}\PY{p}{:}
                 \PY{c+c1}{\PYZsh{}replace values have not yet rated by 0 }
                 \PY{n}{Y\PYZus{}pred} \PY{o}{=} \PY{n}{Yhat}\PY{o}{.}\PY{n}{copy}\PY{p}{(}\PY{p}{)}
                 \PY{n}{Y\PYZus{}pred}\PY{p}{[}\PY{n}{R} \PY{o}{==} \PY{l+m+mi}{0}\PY{p}{]} \PY{o}{=} \PY{l+m+mi}{0}
                 \PY{k}{return} \PY{n}{Y\PYZus{}pred}
             
             \PY{k}{def} \PY{n+nf}{loss}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{,} \PY{n}{Y}\PY{p}{,} \PY{n}{Yhat}\PY{p}{)}\PY{p}{:}
                 \PY{n}{error} \PY{o}{=} \PY{n}{Y}\PY{o}{\PYZhy{}}\PY{n}{Yhat}
                 \PY{n}{n\PYZus{}ratings} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{sum}\PY{p}{(}\PY{n}{Y} \PY{o}{!=} \PY{l+m+mi}{0}\PY{p}{)}
                 \PY{n}{loss\PYZus{}value} \PY{o}{=} \PY{l+m+mi}{1}\PY{o}{/}\PY{p}{(}\PY{l+m+mi}{2}\PY{o}{*}\PY{n}{n\PYZus{}ratings}\PY{p}{)}\PY{o}{*}\PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{norm}\PY{p}{(}\PY{n}{error}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{fro}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2} \PY{o}{+}\PYZbs{}
                 \PY{n}{lamda}\PY{o}{/}\PY{l+m+mi}{2}\PY{o}{*}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{norm}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{I}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{fro}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2} \PY{o}{+} \PYZbs{}
                          \PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{norm}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{U}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{fro}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{)}
                 \PY{k}{return} \PY{n}{loss\PYZus{}value}
             
             \PY{k}{def} \PY{n+nf}{RMSE}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{,} \PY{n}{Y}\PY{p}{,} \PY{n}{Yhat}\PY{p}{)}\PY{p}{:}
                 \PY{n}{error} \PY{o}{=} \PY{n}{Y} \PY{o}{\PYZhy{}} \PY{n}{Yhat}
                 \PY{n}{n\PYZus{}ratings} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{sum}\PY{p}{(}\PY{n}{Y} \PY{o}{!=} \PY{l+m+mi}{0}\PY{p}{)}
                 \PY{n}{rmse} \PY{o}{=} \PY{n}{math}\PY{o}{.}\PY{n}{sqrt}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{norm}\PY{p}{(}\PY{n}{error}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{fro}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{o}{/}\PY{n}{n\PYZus{}ratings}\PY{p}{)}
                 \PY{k}{return} \PY{n}{rmse}
\end{Verbatim}

    \textbf{Xây dựng class MF quản lý model và data:}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}22}]:} \PY{k}{class} \PY{n+nc}{MF}\PY{p}{(}\PY{p}{)}\PY{p}{:}
             \PY{l+s+sd}{\PYZdq{}\PYZdq{}\PYZdq{}}
         \PY{l+s+sd}{    This class used to manage model and data}
         \PY{l+s+sd}{    Two main arguments:}
         \PY{l+s+sd}{    data: control the data}
         \PY{l+s+sd}{    model: control the functions which execute model}
         \PY{l+s+sd}{    \PYZdq{}\PYZdq{}\PYZdq{}}
             \PY{k}{def} \PY{n+nf}{\PYZus{}\PYZus{}init\PYZus{}\PYZus{}}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{,} \PY{n}{data}\PY{p}{,} \PY{n}{model}\PY{p}{,} \PY{n}{n\PYZus{}iter}\PY{p}{,} \PY{n}{print\PYZus{}log\PYZus{}iter}\PY{p}{)}\PY{p}{:}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{data} \PY{o}{=} \PY{n}{data}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{model} \PY{o}{=} \PY{n}{model}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{n\PYZus{}iter} \PY{o}{=} \PY{n}{n\PYZus{}iter}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{print\PYZus{}log\PYZus{}iter} \PY{o}{=} \PY{n}{print\PYZus{}log\PYZus{}iter}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{Y\PYZus{}pred\PYZus{}train} \PY{o}{=} \PY{k+kc}{None}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{Y\PYZus{}pred\PYZus{}test} \PY{o}{=} \PY{k+kc}{None}
                 \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{Yhat} \PY{o}{=} \PY{k+kc}{None}
                 
             \PY{k}{def} \PY{n+nf}{fit}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{)}\PY{p}{:}
                 \PY{k}{for} \PY{n}{i} \PY{o+ow}{in} \PY{n+nb}{range}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{n\PYZus{}iter}\PY{p}{)}\PY{p}{:}
                     \PY{c+c1}{\PYZsh{}update U and I}
                     \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{model}\PY{o}{.}\PY{n}{updateU}\PY{p}{(}\PY{p}{)}
                     \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{model}\PY{o}{.}\PY{n}{updateI}\PY{p}{(}\PY{p}{)}
                     \PY{c+c1}{\PYZsh{}calculate Y\PYZus{}hat}
                     \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{Yhat} \PY{o}{=} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{model}\PY{o}{.}\PY{n}{pred}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{model}\PY{o}{.}\PY{n}{I}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{model}\PY{o}{.}\PY{n}{U}\PY{p}{)}
                     \PY{c+c1}{\PYZsh{}calculate Y\PYZus{}pred\PYZus{}train by replace non ratings by 0}
                     \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{Y\PYZus{}pred\PYZus{}train} \PY{o}{=} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{model}\PY{o}{.}\PY{n}{pred\PYZus{}train\PYZus{}test}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{Yhat}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{data}\PY{o}{.}\PY{n}{Rtrain}\PY{p}{)}
                     \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{Y\PYZus{}pred\PYZus{}test}  \PY{o}{=} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{model}\PY{o}{.}\PY{n}{pred\PYZus{}train\PYZus{}test}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{Yhat}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{data}\PY{o}{.}\PY{n}{Rtest}\PY{p}{)}
                     \PY{k}{if} \PY{n}{i} \PY{o}{\PYZpc{}} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{print\PYZus{}log\PYZus{}iter} \PY{o}{==} \PY{l+m+mi}{0}\PY{p}{:}
                         \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Iteration: }\PY{l+s+si}{\PYZob{}\PYZcb{}}\PY{l+s+s1}{; RMSE: }\PY{l+s+si}{\PYZob{}\PYZcb{}}\PY{l+s+s1}{; Loss value: }\PY{l+s+si}{\PYZob{}\PYZcb{}}\PY{l+s+s1}{\PYZsq{}}\PY{o}{.}\PYZbs{}
                               \PY{n+nb}{format}\PY{p}{(}\PY{n}{i}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{model}\PY{o}{.}\PY{n}{RMSE}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{data}\PY{o}{.}\PY{n}{Ytest}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{Y\PYZus{}pred\PYZus{}test}\PY{p}{)}\PY{p}{,}\PYZbs{}
                                      \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{model}\PY{o}{.}\PY{n}{loss}\PY{p}{(}\PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{data}\PY{o}{.}\PY{n}{Ytrain}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{Y\PYZus{}pred\PYZus{}train}\PY{p}{)}\PY{p}{)}\PY{p}{)}
                         
             \PY{k}{def} \PY{n+nf}{recommend\PYZus{}for\PYZus{}user}\PY{p}{(}\PY{n+nb+bp}{self}\PY{p}{,} \PY{n}{user\PYZus{}id}\PY{p}{,} \PY{n}{k\PYZus{}neighbors}\PY{p}{)}\PY{p}{:}
                 \PY{n}{recm} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{concatenate}\PY{p}{(}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{arange}\PY{p}{(}\PY{l+m+mi}{1}\PY{p}{,} \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{Y\PYZus{}pred\PYZus{}test}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{)}\PY{o}{.}\PY{n}{reshape}\PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{)}\PY{p}{,} \PYZbs{}
                                        \PY{n+nb+bp}{self}\PY{o}{.}\PY{n}{Y\PYZus{}pred\PYZus{}test}\PY{p}{[}\PY{p}{:}\PY{p}{,} \PY{n}{user\PYZus{}id} \PY{o}{\PYZhy{}} \PY{l+m+mi}{1}\PY{p}{]}\PY{o}{.}\PY{n}{reshape}\PY{p}{(}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{)}\PY{p}{)}\PY{p}{,} \PY{n}{axis} \PY{o}{=} \PY{l+m+mi}{1}\PY{p}{)}
                 \PY{n}{recm}\PY{o}{.}\PY{n}{sort}\PY{p}{(}\PY{n}{axis} \PY{o}{=} \PY{l+m+mi}{0}\PY{p}{)}
                 \PY{n+nb}{print}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Top }\PY{l+s+si}{\PYZpc{}s}\PY{l+s+s1}{ item\PYZus{}id recommended to user\PYZus{}id }\PY{l+s+si}{\PYZpc{}s}\PY{l+s+s1}{: }\PY{l+s+si}{\PYZpc{}s}\PY{l+s+s1}{\PYZsq{}}\PY{o}{\PYZpc{}}\PYZbs{}
                       \PY{p}{(}\PY{n}{k\PYZus{}neighbors}\PY{p}{,} \PY{n}{user\PYZus{}id}\PY{p}{,} \PY{n+nb}{str}\PY{p}{(}\PY{n}{recm}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{n}{k\PYZus{}neighbors}\PY{p}{:}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{]}\PY{p}{)}\PY{p}{)}\PY{p}{)}
\end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}23}]:} \PY{n}{data} \PY{o}{=} \PY{n}{Data}\PY{p}{(}\PY{n}{dataset} \PY{o}{=} \PY{n}{movie\PYZus{}length}\PY{p}{,} \PY{n}{split\PYZus{}rate} \PY{o}{=} \PY{l+m+mi}{2}\PY{o}{/}\PY{l+m+mi}{3}\PY{p}{)}
         \PY{n}{model} \PY{o}{=} \PY{n}{Model}\PY{p}{(}\PY{n}{data} \PY{o}{=} \PY{n}{data}\PY{p}{,} \PY{n}{theta} \PY{o}{=} \PY{l+m+mf}{0.75}\PY{p}{,} \PY{n}{lamda} \PY{o}{=} \PY{l+m+mf}{0.1}\PY{p}{,} \PY{n}{K} \PY{o}{=} \PY{l+m+mi}{2}\PY{p}{)}
         \PY{n}{mf} \PY{o}{=} \PY{n}{MF}\PY{p}{(}\PY{n}{data} \PY{o}{=} \PY{n}{data}\PY{p}{,} \PY{n}{model} \PY{o}{=} \PY{n}{model}\PY{p}{,} \PY{n}{n\PYZus{}iter} \PY{o}{=} \PY{l+m+mi}{100}\PY{p}{,} \PY{n}{print\PYZus{}log\PYZus{}iter} \PY{o}{=} \PY{l+m+mi}{10}\PY{p}{)}
         \PY{n}{mf}\PY{o}{.}\PY{n}{fit}\PY{p}{(}\PY{p}{)}
\end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\}]
Iteration: 0; RMSE: 1.2230236685162748; Loss value: 681.8471565701848
Iteration: 10; RMSE: 1.1780718373263668; Loss value: 286.40240426148296
Iteration: 20; RMSE: 1.087117979096145; Loss value: 518.2976746384784
Iteration: 30; RMSE: 1.08441027204107; Loss value: 534.4106319526331
Iteration: 40; RMSE: 1.08385608972465; Loss value: 546.1164972768984
Iteration: 50; RMSE: 1.0828157171073196; Loss value: 559.6753058301773
Iteration: 60; RMSE: 1.079754860855491; Loss value: 575.3332305811103
Iteration: 70; RMSE: 1.0750987045005322; Loss value: 590.821120508004
Iteration: 80; RMSE: 1.0709110406988624; Loss value: 602.5417655852891
Iteration: 90; RMSE: 1.0685236770672915; Loss value: 608.9641965725858

    \end{Verbatim}

    Ta nhận thấy kết quả của hàm \texttt{loss\ function} và \texttt{RMSE}
giảm dần sau các vòng lặp. Điều đó cho thấy thuật toán
\texttt{gradient\ descent} đã phát huy tác dụng trong việc làm giảm sai
số dự báo. Tuy nhiên đôi khi chúng ta sẽ gặp tình huống
\texttt{loss\ function} và \texttt{RMSE} tăng dần. Có nhiều nguyên nhân
dẫn tới điều này chẳng hạn như hệ số \texttt{learning\ rate} và
\texttt{regularization} được thiết lập quá cao làm thuật toán nhảy ra
khỏi cực trị toàn cục hoặc cũng có thể các \texttt{loss\ function} chỉ
tăng tạm thời và giảm sau đó để nghiệm di chuyển qua điểm cực trị địa
phương. Đối với khả năng 1 chúng ta cần điều chỉnh lại các hệ số
\texttt{learning\ rate} và \texttt{regularization} để thuật toán di
chuyển đúng hướng tới nghiệm tối ưu. Khả năng thứ 2 không quá nghiêm
trọng bởi thuật toán có thể di chuyển tới nghiệm tối ưu ngay sau đó.

Recommend 10 sản phẩm tiềm năng nhất cho user\_id = 200:

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}24}]:} \PY{n}{mf}\PY{o}{.}\PY{n}{recommend\PYZus{}for\PYZus{}user}\PY{p}{(}\PY{n}{user\PYZus{}id} \PY{o}{=} \PY{l+m+mi}{200}\PY{p}{,} \PY{n}{k\PYZus{}neighbors} \PY{o}{=} \PY{l+m+mi}{10}\PY{p}{)}
\end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\}]
Top 10 item\_id recommended to user\_id 200: [3943 3944 3945 3946 3947 3948 3949 3950 3951 3952]

    \end{Verbatim}

    \subsection{2.3. Tài liệu tham
khảo}\label{tuxe0i-liux1ec7u-tham-khux1ea3o}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \href{http://infolab.stanford.edu/~ullman/mmds/ch9.pdf}{Recommendation
  System - Stanford}
\item
  \href{https://www.youtube.com/watch?v=h9gpufJFF-0\&t=436s}{Collaborative
  Filtering Youtube - Stanford}
\item
  \href{https://www.youtube.com/watch?v=YW2b8La2ICo}{Recommendation
  System - Machine Learning - Andrew Ng}
\item
  \href{https://machinelearningcoban.com/2017/05/31/matrixfactorization/}{Matrix
  Factorization - Machine Learning Cơ Bản - Tiep Huu Vu}
\item
  \href{https://datajobs.com/data-science-repo/Recommender-Systems-\%5BNetflix\%5D.pdf}{Matrix
  Factorization techniques for recommender systems}
\item
  \href{https://archive.siam.org/meetings/sdm06/proceedings/059zhangs2.pdf}{Learning
  from Incomplete Ratings Using Non-negative Matrix Factorization}
\item
  \href{http://www.albertauyeung.com/post/python-matrix-factorization/}{Matrix
  Factorization - Albert Au Yeung}
\item
  \href{http://hebb.mit.edu/people/seung/papers/nmfconverge.pdf}{Algorithms
  for Non-negative Matrix Factorization - Daniel D.Lee and H. Sebastian
  Seung}
\end{enumerate}


    % Add a bibliography block to the postdoc
    
    
    
    \end{document}
